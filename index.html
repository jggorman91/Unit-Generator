<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-6 Unit Plan Generator (Interactive & Enhanced - v5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tooltip {
            position: absolute;
            background-color: #334155; /* slate-700 */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-trigger {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background-color: #e2e8f0; /* slate-200 */
            color: #0f172a; /* slate-900 */
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 6px;
            cursor: help;
            user-select: none;
        }
        .tooltip-trigger:hover, .tooltip-trigger:focus {
            background-color: #cbd5e1; /* slate-300 */
            outline: none;
        }

        /* Print Styles */
        @media print {
            @page {
                margin: 20mm 15mm;
            }
            body > *:not(#resultsContainer) {
                display: none !important;
            }
            #resultsContainer, #resultsContainer * {
                visibility: visible;
            }
             #results {
                box-shadow: none;
                border: none;
                padding: 0;
             }
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 md:p-8">

    <div id="skillTooltip" class="tooltip"></div>

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 md:p-10">
        <header class="mb-8 text-center no-print">
            <h1 class="text-4xl font-bold text-sky-700" style="font-family: 'Pacifico', cursive;">Interactive Unit Plan Generator</h1>
            <p class="text-slate-600 mt-2">Customize your K-6 unit plans for Executive Function and Social-Emotional Learning.</p>
        </header>

        <form id="unitPlanForm" class="space-y-6 no-print">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="gradeLevel" class="block text-sm font-medium text-slate-700 mb-1">Grade Level:</label>
                    <select id="gradeLevel" name="gradeLevel" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="K-1">K–1</option>
                        <option value="2-3">2–3</option>
                        <option value="4-6">4–6</option>
                    </select>
                </div>
                <div>
                    <label for="numWeeks" class="block text-sm font-medium text-slate-700 mb-1">Unit Length:</label>
                    <select id="numWeeks" name="numWeeks" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="1">1 Week</option>
                        <option value="2">2 Weeks</option>
                        <option value="3">3 Weeks</option>
                        <option value="4">4 Weeks</option>
                    </select>
                </div>
                <div>
                    <label for="lessonsPerWeek" class="block text-sm font-medium text-slate-700 mb-1">Sessions/Week:</label>
                    <select id="lessonsPerWeek" name="lessonsPerWeek" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="2">2 Sessions</option>
                        <option value="3">3 Sessions</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <fieldset>
                    <legend class="text-lg font-semibold text-sky-600 mb-2">Executive Functioning Skills:</legend>
                    <div id="efSkillsContainer" class="space-y-2 max-h-60 overflow-y-auto p-3 border rounded-md border-slate-200">
                        <p>Loading EF skills...</p>
                    </div>
                </fieldset>
                <fieldset>
                    <legend class="text-lg font-semibold text-rose-600 mb-2">Behavior Skill Areas:</legend>
                    <div id="behSkillsContainer" class="space-y-2 max-h-60 overflow-y-auto p-3 border rounded-md border-slate-200">
                        <p>Loading Behavior skills...</p>
                    </div>
                </fieldset>
            </div>

            <fieldset>
                <legend class="text-lg font-semibold text-slate-700">Primary Focus Skills (Optional)</legend>
                <p class="text-xs text-slate-500 mb-2" id="primary-skills-desc">Select 1 or 2 skills from your checked lists above to give them more emphasis.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="primarySkill1" class="block text-sm font-medium text-slate-700 mb-1">Primary Skill 1:</label>
                        <select id="primarySkill1" name="primarySkill1" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-slate-200" disabled aria-describedby="primary-skills-desc">
                            <option value="">-- Check a skill above --</option>
                        </select>
                    </div>
                    <div>
                        <label for="primarySkill2" class="block text-sm font-medium text-slate-700 mb-1">Primary Skill 2:</label>
                        <select id="primarySkill2" name="primarySkill2" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-slate-200" disabled aria-describedby="primary-skills-desc">
                             <option value="">-- Check a skill above --</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <div>
                <label for="studentInterests" class="block text-sm font-medium text-slate-700 mb-1">Student Interests (Optional, comma-separated):</label>
                <input type="text" id="studentInterests" name="studentInterests" placeholder="e.g., dinosaurs, space, drawing" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                 <p class="text-xs text-slate-500 mt-1">Helps tailor examples and scenarios.</p>
            </div>
            
            <fieldset>
                <legend class="text-lg font-semibold text-slate-700">Preferred Teaching Modalities (Optional)</legend>
                 <p class="text-xs text-slate-500 mb-2">Select up to two preferred styles to influence activity suggestions.</p>
                <div id="teachingModalitiesContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                    <!-- Modalities will be dynamically populated by JS for maintainability -->
                </div>
            </fieldset>

            <div id="errorMessage" class="text-red-600 text-sm hidden font-medium" role="alert" aria-live="assertive">Please select at least one skill.</div>

            <div id="generationProgressBarContainer" class="hidden w-full bg-slate-200 rounded-full h-2.5">
                <div id="generationProgressBar" class="bg-sky-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>

            <button type="submit" id="generateButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">
                Generate Unit Plan
            </button>
        </form>

        <div id="loadingIndicator" class="hidden text-center my-8" aria-live="assertive">
             <div class="inline-flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sky-600 text-lg font-semibold">Generating your interactive unit plan...</span>
            </div>
        </div>

        <div id="resultsContainer" class="mt-10 hidden">
            <div class="flex justify-between items-center mb-4 no-print">
                <h2 class="text-2xl font-bold text-sky-700">Generated Unit Plan</h2>
                <div>
                    <button type="button" id="printButton" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50 text-sm">
                        Print
                    </button>
                </div>
            </div>
            <div id="results" class="bg-slate-50 p-4 md:p-6 rounded-lg border border-slate-200 prose max-w-none prose-headings:text-sky-700 prose-h3:text-sky-600 prose-strong:text-slate-700">
            </div>
        </div>
    </div>

    <footer class="text-center mt-12 pb-8 no-print">
         <p class="text-sm text-slate-500">Content generated is for educational purposes and should be reviewed by a qualified educator.</p>
    </footer>

<script>
// Encapsulate all logic in a single object to avoid polluting the global scope
const UnitPlanGenerator = {
    // --- 1. CONFIGURATION & DATA ---
    config: {
        isPaidTier: true, 
        maxFreeWeeks: 2, 
        skillDefinitions: {
             "Working Memory": "The ability to hold and manipulate information in mind for short periods. For example, remembering multi-step instructions or details of a story.",
             "Inhibition (Impulse Control)": "The capacity to pause and think before acting or speaking. Helps resist distractions or urges. Essential for following rules and delaying gratification.",
             "Cognitive Flexibility": "The ability to switch perspectives, adapt to new tasks, rules, or unexpected changes. Enables handling changes and finding multiple solutions to problems.",
             "Planning and Organization": "The ability to set goals, develop steps to reach them, and organize materials, information, or ideas. Vital for projects and tasks.",
             "Emotional Regulation (EF)": "The ability to understand and manage one's emotions effectively. Helps cope with frustration, excitement, or disappointment in an appropriate manner.",
             "Initiation": "The ability to begin tasks promptly and independently, without procrastination. Overcoming inertia to start an activity.",
             "Self-Monitoring (EF)": "The ability to monitor and evaluate one's own performance, behavior, or understanding, including noticing mistakes and checking work. Part of metacognition.",
             "Time Management": "The ability to estimate time needed for tasks, prioritize activities, meet deadlines, and use time effectively.",
             "Social Skills": "Skills for interacting positively and effectively with others, including verbal and non-verbal communication, cooperation, sharing, and understanding social cues.",
             "Emotional Regulation (BS)": "Managing emotional reactions and expressions appropriately in social contexts and various situations. Focuses on the behavioral output of emotional states.",
             "Self-Monitoring (BS)": "Awareness and adjustment of one's behavior in social and learning environments based on feedback (internal or external) and self-assessment.",
             "Impulse Control (BS)": "Controlling behavioral urges and reactions by pausing and thinking before acting, particularly in response to immediate desires or provocations.",
             "Adaptive Behavior": "Skills needed for daily living, problem-solving in everyday situations, and adjusting to different environments and social demands. Includes practical life skills.",
             "Communication Skills": "Effectively conveying and receiving information, ideas, and feelings, both verbally (e.g., asking for help, expressing needs) and non-verbally (e.g., body language).",
             "Conflict Resolution": "Skills to peacefully and constructively resolve disagreements and problems with others, including listening, negotiation, and finding compromises.",
             "Attention and Focus": "The ability to sustain concentration on tasks, filter out distractions, and direct mental effort appropriately, even when tasks are challenging or less interesting."
        },
        efSkills: [
             { value: "Working Memory", display: "Working Memory" },
             { value: "Inhibition (Impulse Control)", display: "Inhibition (Impulse Control)" },
             { value: "Cognitive Flexibility", display: "Cognitive Flexibility" },
             { value: "Planning and Organization", display: "Planning and Organization" },
             { value: "Emotional Regulation (EF)", display: "Emotional Regulation (EF)" },
             { value: "Initiation", display: "Initiation" },
             { value: "Self-Monitoring (EF)", display: "Self-Monitoring (EF)" },
             { value: "Time Management", display: "Time Management" }
        ],
        behSkills: [
            { value: "Social Skills", display: "Social Skills" },
            { value: "Emotional Regulation (BS)", display: "Emotional Regulation (BS)" },
            { value: "Self-Monitoring (BS)", display: "Self-Monitoring (BS)" },
            { value: "Impulse Control (BS)", display: "Impulse Control (BS)" },
            { value: "Adaptive Behavior", display: "Adaptive Behavior" },
            { value: "Communication Skills", display: "Communication Skills" },
            { value: "Conflict Resolution", display: "Conflict Resolution" },
            { value: "Attention and Focus", display: "Attention and Focus" }
        ],
        teachingModalities: [
            { value: "gameBased", display: "Game-Based" },
            { value: "movementKinesthetic", display: "Movement/Kinesthetic" },
            { value: "artsCrafts", display: "Arts & Crafts" },
            { value: "storytellingDrama", display: "Storytelling/Drama" },
            { value: "discussionOriented", display: "Discussion-Oriented" },
            { value: "techIntegration", display: "Tech Integration" }
        ],
        developmentalNotes: {
            "K-1": "Focus on 'Foundational Regulator to Guided Participant'. Students are learning routines, adult guidance, and basic impulse control with support. Socially, they are 'Social Initiators to Emerging Peers', learning simple rules. Language is 'Foundational Communicator to Emerging Conversationalist'. Activities should be short, concrete, and highly scaffolded.",
            "2-3": "Focus on 'Emerging Self-Manager to Flexible Adapter'. Students follow routines with less prompting, show early self-regulation and behavioral awareness. Socially, 'Collaborative Partner to Connected Participant', starting cooperation. Language is 'Functional Speaker to Social Interpreter', maintaining conversations. Activities can involve more steps and some partner work.",
            "4-6": "Focus on 'Intentional Strategist to Reflective Adapter' (4-5) and moving towards 'Independent Regulator to Autonomous Problem-Solver' (6th). Students apply strategies, reflect on behavior. Socially, 'Social Navigator to Empathetic Ally', forming friendships, resolving conflicts. Language is 'Contextual Communicator to Purposeful Speaker', adapting language and discussing with intent. Activities can be more complex, involve group work, and encourage metacognition."
        },
        caselCompetenciesMap: { 
            "Working Memory": ["Self-Management", "Responsible Decision-Making"], "Inhibition (Impulse Control)": ["Self-Management", "Relationship Skills"], "Cognitive Flexibility": ["Social Awareness", "Responsible Decision-Making", "Self-Management"], "Planning and Organization": ["Self-Management", "Responsible Decision-Making"], "Emotional Regulation (EF)": ["Self-Awareness", "Self-Management"], "Initiation": ["Self-Management", "Responsible Decision-Making"], "Self-Monitoring (EF)": ["Self-Awareness", "Responsible Decision-Making", "Self-Management"], "Time Management": ["Self-Management", "Responsible Decision-Making"], "Social Skills": ["Social Awareness", "Relationship Skills"], "Emotional Regulation (BS)": ["Self-Awareness", "Self-Management", "Relationship Skills"], "Self-Monitoring (BS)": ["Self-Awareness", "Responsible Decision-Making", "Self-Management"], "Impulse Control (BS)": ["Self-Management", "Relationship Skills"], "Adaptive Behavior": ["Self-Management", "Responsible Decision-Making", "Social Awareness"], "Communication Skills": ["Relationship Skills", "Social Awareness"], "Conflict Resolution": ["Relationship Skills", "Responsible Decision-Making", "Social Awareness"], "Attention and Focus": ["Self-Management"]
        },
        bloomVerbs: {
            remember: ["Define", "List", "Recall", "Name", "Identify", "Repeat", "State"],
            understand: ["Explain", "Summarize", "Describe", "Discuss", "Paraphrase", "Classify", "Report"],
            apply: ["Use", "Demonstrate", "Illustrate", "Solve", "Practice", "Choose", "Apply"],
            analyze: ["Compare", "Contrast", "Differentiate", "Organize", "Distinguish", "Examine", "Categorize"],
            evaluate: ["Justify", "Critique", "Assess", "Recommend", "Appraise", "Argue", "Support"],
            create: ["Design", "Develop", "Construct", "Formulate", "Invent", "Compose", "Plan (a new thing)"]
        }
    },

    // --- 2. APPLICATION STATE ---
    state: {}, 

    // --- 3. DOM ELEMENTS ---
    elements: {},

    // --- 4. EVENT HANDLERS ---
    handlers: {
        handleFormSubmit(event) {
            event.preventDefault();
            UnitPlanGenerator.ui.updateStateFromForm();
            
            const { selectedEfSkills, selectedBehSkills } = UnitPlanGenerator.state;
            const allSelectedSkills = [...selectedEfSkills, ...selectedBehSkills];

            if (allSelectedSkills.length === 0) {
                UnitPlanGenerator.ui.showError("Please select at least one skill.");
                return;
            }

            UnitPlanGenerator.ui.hideError();
            UnitPlanGenerator.ui.showLoading();

            setTimeout(() => {
                try {
                    const unitPlanHtml = UnitPlanGenerator.content.generateUnitPlan();
                    UnitPlanGenerator.ui.displayResults(unitPlanHtml);
                } catch (error) {
                    console.error("Error during unit plan generation:", error.stack);
                    UnitPlanGenerator.ui.displayError("An error occurred. Please check the console for details.");
                } finally {
                    UnitPlanGenerator.ui.hideLoading();
                }
            }, 700);
        },

        handleSkillChange() {
            UnitPlanGenerator.ui.updatePrimarySkillDropdowns();
        },
        
        showTooltip(event) { 
            const trigger = event.currentTarget;
            const skillKey = trigger.dataset.skill;
            const definition = UnitPlanGenerator.config.skillDefinitions[skillKey] || "No definition available.";
            const tooltip = UnitPlanGenerator.elements.skillTooltip;
            
            tooltip.innerHTML = `<strong>${UnitPlanGenerator.content.getUniqueSkillName(skillKey)}:</strong><br>${definition}`;
            
            const rect = trigger.getBoundingClientRect();
            let leftPos = rect.left + window.scrollX;
            let topPos = rect.bottom + window.scrollY + 5;
            
            tooltip.style.left = `${leftPos}px`;
            tooltip.style.top = `${topPos}px`;
            tooltip.classList.add('visible');
            
            const tooltipRect = tooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) {
                tooltip.style.left = `${window.innerWidth - tooltipRect.width - 10 + window.scrollX}px`;
            }
            if (tooltipRect.bottom > window.innerHeight && tooltipRect.height < rect.top) {
                tooltip.style.top = `${rect.top + window.scrollY - tooltipRect.height - 5}px`;
            }
        },

        hideTooltip() { 
            UnitPlanGenerator.elements.skillTooltip.classList.remove('visible');
        },
        
        handleDocumentClick(event) {
            const tooltip = UnitPlanGenerator.elements.skillTooltip;
            if (tooltip.classList.contains('visible') && !tooltip.contains(event.target) && !event.target.classList.contains('tooltip-trigger')) {
                UnitPlanGenerator.handlers.hideTooltip();
            }
        },

        handlePrint() {
            window.print();
        }
    },

    // --- 5. UI MANIPULATION ---
    ui: {
        populateCheckboxes(container, skills, groupName, colorClass, eventHandler) {
             container.innerHTML = '';
             skills.forEach((skill, index) => {
                const label = document.createElement('label');
                label.className = `flex items-center space-x-3 p-2 rounded-md hover:bg-${colorClass}-50 transition-colors`;
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = groupName;
                input.value = skill.value;
                input.id = `${groupName}_${index}`;
                input.className = `form-checkbox h-5 w-5 text-${colorClass}-600 border-slate-400 rounded focus:ring-${colorClass}-500`;
                input.addEventListener('change', eventHandler);

                const span = document.createElement('span');
                span.className = 'text-slate-700';
                span.textContent = skill.display;
                
                const tooltipTrigger = document.createElement('span');
                tooltipTrigger.className = 'tooltip-trigger';
                tooltipTrigger.textContent = '?';
                tooltipTrigger.setAttribute('data-skill', skill.value);
                tooltipTrigger.setAttribute('tabindex', '0');
                tooltipTrigger.addEventListener('mouseenter', UnitPlanGenerator.handlers.showTooltip);
                tooltipTrigger.addEventListener('mouseleave', UnitPlanGenerator.handlers.hideTooltip);
                tooltipTrigger.addEventListener('focus', UnitPlanGenerator.handlers.showTooltip);
                tooltipTrigger.addEventListener('blur', UnitPlanGenerator.handlers.hideTooltip);
                
                label.append(input, span, tooltipTrigger);
                container.appendChild(label);
            });
        },

        populateModalities() {
            const container = UnitPlanGenerator.elements.teachingModalitiesContainer;
            container.innerHTML = '';
            UnitPlanGenerator.config.teachingModalities.forEach(modality => {
                 const label = document.createElement('label');
                 label.className = 'flex items-center space-x-2';
                 label.innerHTML = `
                    <input type="checkbox" name="teachingModalities" value="${modality.value}" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                    <span class="text-sm text-slate-700">${modality.display}</span>
                 `;
                 container.appendChild(label);
            });
        },

        updatePrimarySkillDropdowns() {
            const { efSkillsContainer, behSkillsContainer, primarySkill1, primarySkill2 } = UnitPlanGenerator.elements;
            const checkedSkills = [
                ...efSkillsContainer.querySelectorAll('input:checked'),
                ...behSkillsContainer.querySelectorAll('input:checked')
            ].map(cb => ({ value: cb.value, text: UnitPlanGenerator.content.getUniqueSkillName(cb.value) }));
            
            const selects = [primarySkill1, primarySkill2];
            selects.forEach(select => {
                const currentlySelected = select.value;
                select.innerHTML = ''; 
                
                if (checkedSkills.length === 0) {
                    select.innerHTML = '<option value="">-- Check a skill above --</option>';
                    select.disabled = true;
                } else {
                    select.disabled = false;
                    select.innerHTML = '<option value="">-- None --</option>';
                    checkedSkills.forEach(skill => {
                        const option = new Option(skill.text, skill.value);
                        select.add(option);
                    });
                    if (checkedSkills.some(skill => skill.value === currentlySelected)) {
                        select.value = currentlySelected;
                    }
                }
            });
        },

        updateStateFromForm() {
            const { elements, config } = UnitPlanGenerator;
            let numWeeks = parseInt(elements.numWeeks.value);
            if (!config.isPaidTier && numWeeks > config.maxFreeWeeks) {
                numWeeks = config.maxFreeWeeks;
                elements.numWeeks.value = numWeeks;
            }

            UnitPlanGenerator.state = {
                gradeLevel: elements.gradeLevel.value,
                numWeeks: numWeeks,
                lessonsPerWeek: parseInt(elements.lessonsPerWeek.value),
                selectedEfSkills: Array.from(elements.efSkillsContainer.querySelectorAll('input:checked')).map(cb => cb.value),
                selectedBehSkills: Array.from(elements.behSkillsContainer.querySelectorAll('input:checked')).map(cb => cb.value),
                primarySkills: [elements.primarySkill1.value, elements.primarySkill2.value].filter(Boolean),
                studentInterests: elements.studentInterests.value.trim().split(',').map(s => s.trim()).filter(Boolean),
                preferredModalities: Array.from(elements.teachingModalitiesContainer.querySelectorAll('input:checked')).map(cb => cb.value)
            };
        },
        
        showLoading() {
            UnitPlanGenerator.elements.loadingIndicator.classList.remove('hidden');
            UnitPlanGenerator.elements.resultsContainer.classList.add('hidden');
            UnitPlanGenerator.elements.generationProgressBarContainer.classList.remove('hidden');
            UnitPlanGenerator.elements.generationProgressBar.style.width = '0%';
            let progress = 0;
            const interval = setInterval(() => {
                progress += 15;
                UnitPlanGenerator.elements.generationProgressBar.style.width = `${Math.min(progress, 100)}%`;
                if (progress >= 100) clearInterval(interval);
            }, 100);
        },

        hideLoading() {
            UnitPlanGenerator.elements.loadingIndicator.classList.add('hidden');
            UnitPlanGenerator.elements.generationProgressBarContainer.classList.add('hidden');
        },

        displayResults(html) {
            UnitPlanGenerator.elements.results.innerHTML = html;
            UnitPlanGenerator.elements.resultsContainer.classList.remove('hidden');
            UnitPlanGenerator.elements.resultsContainer.scrollIntoView({ behavior: 'smooth' });
        },

        showError(message) {
            UnitPlanGenerator.elements.errorMessage.textContent = message;
            UnitPlanGenerator.elements.errorMessage.classList.remove('hidden');
        },
        
        hideError() {
            UnitPlanGenerator.elements.errorMessage.classList.add('hidden');
        },
        
        displayError(message) {
            UnitPlanGenerator.elements.results.innerHTML = `<p class="text-red-600 font-medium">${message}</p>`;
            UnitPlanGenerator.elements.resultsContainer.classList.remove('hidden');
        }
    },

    // --- 6. CONTENT GENERATION ---
    content: {
        getRandomElement(arr) {
            if (!arr || arr.length === 0) return "";
            return arr[Math.floor(Math.random() * arr.length)];
        },

        getBloomVerbs(gradeLevel = "K-1") {
            const verbs = UnitPlanGenerator.config.bloomVerbs;
            switch (gradeLevel) {
                case "K-1": return this.getRandomElement(verbs.remember.concat(verbs.understand));
                case "2-3": return this.getRandomElement(verbs.understand.concat(verbs.apply));
                case "4-6": return this.getRandomElement(verbs.apply.concat(verbs.analyze, verbs.evaluate));
                default: return this.getRandomElement(verbs.remember);
            }
        },

        getAssociatedSECompetencies(skill) {
            return UnitPlanGenerator.config.caselCompetenciesMap[skill] || ["Self-Management"];
        },
        
        getUniqueSkillName(skill) {
             if (!skill) return "";
             let displayName = skill;
             if (skill.includes("(EF)")) displayName = skill.replace(" (EF)", " (Executive Functioning)");
             else if (skill.includes("(BS)")) displayName = skill.replace(" (BS)", " (Behavioral)");
             return displayName;
        },

        generateSkillList(skillsRaw) {
            const skills = [...new Set(skillsRaw.map(s => this.getUniqueSkillName(s)).filter(Boolean))];
            if (skills.length === 0) return "selected focus areas";
            if (skills.length === 1) return skills[0];
            if (skills.length === 2) return skills.join(' and ');
            return skills.slice(0, -1).join(', ') + ', and ' + skills.slice(-1);
        },
        
        getMaterials(skill, gradeLevel, preferredModalities = []) {
            let materials = ["Whiteboard or chart paper", "Markers", "Paper", "Pencils or crayons"];
            if (gradeLevel !== "K-1") materials.push("Student journals/notebooks");
            if (skill.includes("Time") || skill.includes("Planning")) materials.push("Timer", "Sample checklists");
            if (skill.includes("Emotional")) materials.push("Feeling faces chart", "Role-play cards");
            if (skill.includes("Memory")) materials.push("Picture cards", "Small objects for games");
            if (preferredModalities.includes('artsCrafts')) materials.push("Art supplies (scissors, glue, etc.)");
            return [...new Set(materials)];
        },

        getWarmUp(skill, gradeLevel, studentInterests = []) {
            const skillName = this.getUniqueSkillName(skill);
            let interest = this.getRandomElement(studentInterests) || "a fun topic";
            const warmups = [
                `Mindful Moment: Lead a 1-minute 'Belly Breathing' exercise, perhaps imagining a ${interest} rising and falling.`,
                `Quick Review: "Last time we talked about... Who can share one time they used that skill, maybe when thinking about ${interest}?"`,
                `Skill Chant: Create a short chant for ${skillName}, e.g., "Think it, Plan it, Do it, Check it!" with actions.`
            ];
            return this.getRandomElement(warmups);
        },

        getMiniLesson(skill, gradeLevel, selCompetencies, studentInterests = []) {
            const skillName = this.getUniqueSkillName(skill);
            let interest = this.getRandomElement(studentInterests) || "school subjects";
            const definition = UnitPlanGenerator.config.skillDefinitions[skill] || "our ability to manage our thoughts and actions.";
            return `Today we're activating our **${skillName}** superpowers! This is about ${definition.toLowerCase()}. It helps us learn new things, like cool facts about ${interest}. Let's discuss when this skill is useful...`;
        },

        getCoreActivity(skill, gradeLevel, studentInterests = []) {
            const skillName = this.getUniqueSkillName(skill);
            let interest = this.getRandomElement(studentInterests) || "a fun project";
            let activity = {
                title: `Strengthening Our ${skillName}`,
                description: `Let's dive into an activity to build our ${skillName.toLowerCase()}.`,
                steps: ["Follow teacher's instructions.", "Participate respectfully.", "Reflect on your experience."],
                differentiation: "Adjust complexity based on student responses. Provide sentence starters or visual aids."
            };

            if (skill.includes("Planning")) {
                activity.title = `${interest}-Themed Master Planners`;
                activity.description = `Effective ${skillName.toLowerCase()} is like drawing a map for a journey! It helps us complete tasks like a ${interest} diorama.`;
                if (gradeLevel === "K-1") {
                    activity.steps = ["Teacher presents a 3-step visual sequence for a simple task.", "Students point to each step as the teacher calls it out.", "Complete the task following the visual plan."];
                } else {
                    activity.steps = [`Task: 'Plan 3-4 key events to retell a story about ${interest}.'`, "Students use a 'First, Next, Then, Finally' graphic organizer.", "In pairs, students share their plans and give feedback."];
                }
            } else if (skill.includes("Memory")) {
                activity.title = `${interest}-Themed Memory Wizards`;
                if (gradeLevel === "K-1") {
                    activity.steps = ["Teacher gives a 2-step instruction related to classroom objects (e.g., 'Touch your nose, then clap your hands').", "Students perform the actions.", "Discuss what helped them remember."];
                } else {
                    activity.steps = ["Play 'Memory Chain': Start with 'For our ${interest} adventure, I'm bringing...'. Each student repeats and adds an item.", "Discuss strategies used to remember the chain."];
                }
            }
            return activity;
        },

        getReflection(skill, gradeLevel, studentInterests = []) {
            const skillName = this.getUniqueSkillName(skill);
            let interest = this.getRandomElement(studentInterests) || "something you enjoy";
            return `Gather for a debrief. Ask: "What was one part of our activity that made your brain work hard? How can using ${skillName.toLowerCase()} help you when you are learning about ${interest}?" Use 'turn and talk' for K-3 or a quick journal entry for 4-6.`;
        },
        
        generateSessionContent(rawSkill, gradeLevel, weekNum, lessonNum, allSelectedSkillsRaw, studentInterests, preferredModalities) {
            const skillName = this.getUniqueSkillName(rawSkill);
            const selCompetencies = this.getAssociatedSECompetencies(rawSkill);
            const materials = this.getMaterials(rawSkill, gradeLevel, preferredModalities).join(', ');
            const warmup = this.getWarmUp(rawSkill, gradeLevel, studentInterests);
            const miniLesson = this.getMiniLesson(rawSkill, gradeLevel, selCompetencies, studentInterests);
            const coreActivity = this.getCoreActivity(rawSkill, gradeLevel, studentInterests);
            const reflection = this.getReflection(rawSkill, gradeLevel, studentInterests);

            return `
                <div class="ml-0 md:ml-4 mt-4 p-4 bg-white rounded shadow-md border border-slate-200">
                    <h5 class="text-md font-semibold text-slate-800 mb-2">Week ${weekNum}, Session ${lessonNum} - Focus Skill: ${skillName}</h5>
                    <h6>Learning Objectives:</h6>
                    <ul class="list-disc list-inside pl-4 text-sm">
                        <li>Students will be able to ${this.getBloomVerbs(gradeLevel).toLowerCase()} ${skillName.toLowerCase()}.</li>
                        <li>Students will practice ${selCompetencies[0].toLowerCase()} by engaging in the session activities.</li>
                    </ul>
                    <h6>Materials Needed:</h6><p class="text-sm">${materials}</p>
                    <h6>Warm-Up (Approx. 5 min):</h6><p class="text-sm">${warmup}</p>
                    <h6>Mini-Lesson (Approx. 5-7 min):</h6><p class="text-sm">${miniLesson}</p>
                    <h6>Core Activity: ${coreActivity.title} (Approx. 15-20 min):</h6>
                    <p class="text-sm">${coreActivity.description}</p>
                    <ol class="list-decimal list-inside pl-4 text-sm space-y-1">${coreActivity.steps.map(step => `<li>${step}</li>`).join('')}</ol>
                    <p class="text-xs italic mt-1">Differentiation: ${coreActivity.differentiation}</p>
                    <h6>Wrap-up & Reflection (Approx. 5 min):</h6><p class="text-sm">${reflection}</p>
                </div>
            `;
        },
        
        generateUnitPlan() {
            const { gradeLevel, selectedEfSkills, selectedBehSkills, numWeeks, lessonsPerWeek, primarySkills, studentInterests, preferredModalities } = UnitPlanGenerator.state;
            const allSelectedSkillsRaw = [...selectedEfSkills, ...selectedBehSkills];
            let html = ``;
            
            const titleSkill = primarySkills.length > 0 ? primarySkills[0] : allSelectedSkillsRaw[0];
            const title = `<h2>Unit: Strengthening ${this.getUniqueSkillName(titleSkill)} & Related Skills</h2>`;
            html += title;
            html += `<p><strong>Grade Range:</strong> ${gradeLevel}</p>`;
            html += `<p><strong>Focus Skills:</strong> ${this.generateSkillList(allSelectedSkillsRaw)}</p>`;
            html += `<p><strong>Duration:</strong> ${numWeeks} weeks (${lessonsPerWeek} sessions per week)</p>`;
            
            for (let i = 1; i <= numWeeks; i++) {
                html += `<div class="mt-6 pt-4 border-t border-slate-300 page-break"><h3>Week ${i}</h3>`;
                 for (let j = 1; j <= lessonsPerWeek; j++) {
                     const lessonFocusSkillRaw = allSelectedSkillsRaw[((i-1) * lessonsPerWeek + (j-1)) % allSelectedSkillsRaw.length] || allSelectedSkillsRaw[0];
                     html += this.generateSessionContent(lessonFocusSkillRaw, gradeLevel, i, j, allSelectedSkillsRaw, studentInterests, preferredModalities);
                 }
                html += `</div>`;
            }
            return html;
        }
    },

    // --- 7. INITIALIZATION ---
    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.elements = {
                form: document.getElementById('unitPlanForm'),
                gradeLevel: document.getElementById('gradeLevel'),
                numWeeks: document.getElementById('numWeeks'),
                lessonsPerWeek: document.getElementById('lessonsPerWeek'),
                efSkillsContainer: document.getElementById('efSkillsContainer'),
                behSkillsContainer: document.getElementById('behSkillsContainer'),
                primarySkill1: document.getElementById('primarySkill1'),
                primarySkill2: document.getElementById('primarySkill2'),
                studentInterests: document.getElementById('studentInterests'),
                teachingModalitiesContainer: document.getElementById('teachingModalitiesContainer'),
                errorMessage: document.getElementById('errorMessage'),
                generateButton: document.getElementById('generateButton'),
                loadingIndicator: document.getElementById('loadingIndicator'),
                resultsContainer: document.getElementById('resultsContainer'),
                results: document.getElementById('results'),
                printButton: document.getElementById('printButton'),
                skillTooltip: document.getElementById('skillTooltip'),
                generationProgressBarContainer: document.getElementById('generationProgressBarContainer'),
                generationProgressBar: document.getElementById('generationProgressBar'),
            };

            this.ui.populateCheckboxes(this.elements.efSkillsContainer, this.config.efSkills, 'efSkills', 'sky', this.handlers.handleSkillChange);
            this.ui.populateCheckboxes(this.elements.behSkillsContainer, this.config.behSkills, 'behSkills', 'rose', this.handlers.handleSkillChange);
            this.ui.populateModalities();

            this.elements.form.addEventListener('submit', this.handlers.handleFormSubmit);
            this.elements.printButton.addEventListener('click', this.handlers.handlePrint);
            document.addEventListener('click', this.handlers.handleDocumentClick);
        });
    }
};

UnitPlanGenerator.init();

</script>
</body>
</html>
