<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-6 Unit Plan Generator (Interactive & Enhanced - Debug v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #results::-webkit-scrollbar, .skills-list::-webkit-scrollbar {
            width: 8px;
        }
        #results::-webkit-scrollbar-track, .skills-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #results::-webkit-scrollbar-thumb, .skills-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #results::-webkit-scrollbar-thumb:hover, .skills-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #resultsContainer, #resultsContainer * {
                visibility: visible;
            }
            #results {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                visibility: visible;
            }
            header, form, footer, #printButton, #generateButton, #loadingIndicator, 
            #unitPlanForm div:not(#resultsContainer):not(#results), 
            #unitPlanForm label, #unitPlanForm select, #unitPlanForm h3, .tooltip, .tooltip-trigger {
                display: none !important;
                visibility: hidden !important;
            }
            .page-break { 
                page-break-after: always;
            }
        }
        .prose h4 { margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose h5 { margin-top: 1.25em; margin-bottom: 0.25em; }
        .prose h6 { margin-top: 1em; margin-bottom: 0.25em; font-style: italic; }

        /* Tooltip Styles */
        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 100;
            width: max-content;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
        }
        .tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-trigger {
            cursor: help;
            margin-left: 4px;
            color: #0ea5e9; /* sky-600 */
            font-weight: bold;
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border: 1px solid #0ea5e9;
            border-radius: 50%;
            font-size: 0.75rem;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800 p-4 md:p-8">
    <div id="skillTooltip" class="tooltip"></div>
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 md:p-10">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-700" style="font-family: 'Pacifico', cursive;">Interactive Unit Plan Generator</h1>
            <p class="text-slate-600 mt-2">Customize your K-6 unit plans for Executive Function and Social-Emotional Learning.</p>
        </header>

        <form id="unitPlanForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="gradeLevel" class="block text-sm font-medium text-slate-700 mb-1">Grade Level:</label>
                    <select id="gradeLevel" name="gradeLevel" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="K-1">K–1</option>
                        <option value="2-3">2–3</option>
                        <option value="4-6">4–6</option>
                    </select>
                </div>
                <div>
                    <label for="numWeeks" class="block text-sm font-medium text-slate-700 mb-1">Unit Length:</label>
                    <select id="numWeeks" name="numWeeks" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="4">4 Weeks</option>
                        <option value="5">5 Weeks</option>
                        <option value="6">6 Weeks</option>
                    </select>
                </div>
                <div>
                    <label for="lessonsPerWeek" class="block text-sm font-medium text-slate-700 mb-1">Sessions/Week:</label>
                    <select id="lessonsPerWeek" name="lessonsPerWeek" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="2">2 Sessions</option>
                        <option value="3">3 Sessions</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-sky-600 mb-2">Executive Functioning Skills:</h3>
                    <div id="efSkillsContainer" class="skills-list space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md border-slate-200">
                        <p>Loading EF skills...</p> </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-rose-600 mb-2">Behavior Skill Areas:</h3>
                    <div id="behSkillsContainer" class="skills-list space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md border-slate-200">
                        <p>Loading Behavior skills...</p> </div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">Primary Focus Skills (Optional):</h3>
                <p class="text-xs text-slate-500 mb-2">Select 1 or 2 skills from your checked lists above to give them more emphasis in the unit plan.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="primarySkill1" class="block text-sm font-medium text-slate-700 mb-1">Primary Skill 1:</label>
                        <select id="primarySkill1" name="primarySkill1" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                    <div>
                        <label for="primarySkill2" class="block text-sm font-medium text-slate-700 mb-1">Primary Skill 2:</label>
                        <select id="primarySkill2" name="primarySkill2" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <label for="studentInterests" class="block text-sm font-medium text-slate-700 mb-1">Student Interests (Optional, comma-separated):</label>
                <input type="text" id="studentInterests" name="studentInterests" placeholder="e.g., dinosaurs, space, drawing" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                <p class="text-xs text-slate-500 mt-1">Helps tailor examples and scenarios.</p>
            </div>

            <div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">Preferred Teaching Modalities (Optional):</h3>
                <p class="text-xs text-slate-500 mb-2">Select up to two preferred styles to influence activity suggestions.</p>
                <div id="teachingModalitiesContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="gameBased" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Game-Based</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="movementKinesthetic" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Movement/Kinesthetic</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="artsCrafts" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Arts & Crafts</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="storytellingDrama" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Storytelling/Drama</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="discussionOriented" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Discussion-Oriented</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="techIntegration" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Tech Integration</span>
                    </label>
                </div>
            </div>

            <div id="error-message" class="text-red-500 text-sm hidden">Please select at least one skill from the checkboxes above.</div>
            
            <button type="button" id="generateButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 duration-150 ease-in-out">
                Generate Unit Plan
            </button>
        </form>

        <div id="loadingIndicator" class="hidden text-center my-8">
            <div class="inline-flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sky-600 text-lg font-semibold">Generating your interactive unit plan...</span>
            </div>
        </div>

        <div id="resultsContainer" class="mt-10 hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-sky-700">Generated Unit Plan</h2>
                <button type="button" id="printButton" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50 transition-colors duration-150 ease-in-out">
                    Print Unit Plan
                </button>
            </div>
            <div id="results" class="bg-slate-50 p-4 md:p-6 rounded-lg border border-slate-200 prose max-w-none prose-headings:text-sky-700 prose-h3:text-sky-600 prose-strong:text-slate-700">
                </div>
        </div>
    </div>

    <footer class="text-center mt-12 pb-8">
        <p class="text-sm text-slate-500">Content generated is for educational purposes and should be reviewed by a qualified educator before implementation. All generated content is original and copyright-safe, based on general educational principles and inspired by evidence-based practices and developmental knowledge. Ensure that any student interest inputs are handled appropriately according to privacy best practices.</p>
        <p class="text-xs text-slate-400 mt-1">Tailwind CSS CDN is for development purposes. For production, follow Tailwind CSS installation guidelines.</p>
    </footer>

<script>
    // --- SKILL DEFINITIONS (Ensure these are globally accessible) ---
    const SKILL_DEFINITIONS = {
        "Working Memory": "The ability to hold and manipulate information in mind for short periods. For example, remembering multi-step instructions or details of a story.",
        "Inhibition (Impulse Control)": "The capacity to pause and think before acting or speaking. Helps resist distractions or urges. Essential for following rules and delaying gratification.",
        "Cognitive Flexibility": "The ability to switch perspectives, adapt to new tasks, rules, or unexpected changes. Enables handling changes and finding multiple solutions to problems.",
        "Planning and Organization": "The ability to set goals, develop steps to reach them, and organize materials, information, or ideas. Vital for projects and tasks.",
        "Emotional Regulation (EF)": "The ability to understand and manage one's emotions effectively. Helps cope with frustration, excitement, or disappointment in an appropriate manner.",
        "Initiation": "The ability to begin tasks promptly and independently, without procrastination. Overcoming inertia to start an activity.",
        "Self-Monitoring (EF)": "The ability to monitor and evaluate one's own performance, behavior, or understanding, including noticing mistakes and checking work. Part of metacognition.",
        "Time Management": "The ability to estimate time needed for tasks, prioritize activities, meet deadlines, and use time effectively.",
        "Social Skills": "Skills for interacting positively and effectively with others, including verbal and non-verbal communication, cooperation, sharing, and understanding social cues.",
        "Emotional Regulation (BS)": "Managing emotional reactions and expressions appropriately in social contexts and various situations. Focuses on the behavioral output of emotional states. (Related to EF Emotional Regulation).",
        "Self-Monitoring (BS)": "Awareness and adjustment of one's behavior in social and learning environments based on feedback (internal or external) and self-assessment. (Related to EF Self-Monitoring).",
        "Impulse Control (BS)": "Controlling behavioral urges and reactions by pausing and thinking before acting, particularly in response to immediate desires or provocations. (Related to EF Inhibition).",
        "Adaptive Behavior": "Skills needed for daily living, problem-solving in everyday situations, and adjusting to different environments and social demands. Includes practical life skills.",
        "Communication Skills": "Effectively conveying and receiving information, ideas, and feelings, both verbally (e.g., asking for help, expressing needs) and non-verbally (e.g., body language).",
        "Conflict Resolution": "Skills to peacefully and constructively resolve disagreements and problems with others, including listening, negotiation, and finding compromises.",
        "Attention and Focus": "The ability to sustain concentration on tasks, filter out distractions, and direct mental effort appropriately, even when tasks are challenging or less interesting. (Related to EF skills like inhibition)."
    };

    const ALL_EF_SKILLS = [
        { value: "Working Memory", display: "Working Memory" },
        { value: "Inhibition (Impulse Control)", display: "Inhibition (Impulse Control)" },
        { value: "Cognitive Flexibility", display: "Cognitive Flexibility" },
        { value: "Planning and Organization", display: "Planning and Organization" },
        { value: "Emotional Regulation (EF)", display: "Emotional Regulation (EF)" },
        { value: "Initiation", display: "Initiation" },
        { value: "Self-Monitoring (EF)", display: "Self-Monitoring (EF)" },
        { value: "Time Management", display: "Time Management" }
    ];

    const ALL_BEH_SKILLS = [
        { value: "Social Skills", display: "Social Skills" },
        { value: "Emotional Regulation (BS)", display: "Emotional Regulation (BS)" },
        { value: "Self-Monitoring (BS)", display: "Self-Monitoring (BS)" },
        { value: "Impulse Control (BS)", display: "Impulse Control (BS)" },
        { value: "Adaptive Behavior", display: "Adaptive Behavior" },
        { value: "Communication Skills", display: "Communication Skills" },
        { value: "Conflict Resolution", display: "Conflict Resolution" },
        { value: "Attention and Focus", display: "Attention and Focus" }
    ];

    const DEVELOPMENTAL_NOTES = {
        "K-1": "Focus on 'Foundational Regulator to Guided Participant'. Students are learning routines, adult guidance, and basic impulse control with support. Socially, they are 'Social Initiators to Emerging Peers', learning simple rules. Language is 'Foundational Communicator to Emerging Conversationalist'.",
        "2-3": "Focus on 'Emerging Self-Manager to Flexible Adapter'. Students follow routines with less prompting, show early self-regulation and behavioral awareness. Socially, 'Collaborative Partner to Connected Participant', starting cooperation. Language is 'Functional Speaker to Social Interpreter', maintaining conversations.",
        "4-6": "Focus on 'Intentional Strategist to Reflective Adapter' (4-5) and moving towards 'Independent Regulator to Autonomous Problem-Solver' (6th). Students apply strategies, reflect on behavior. Socially, 'Social Navigator to Empathetic Ally', forming friendships, resolving conflicts. Language is 'Contextual Communicator to Purposeful Speaker', adapting language and discussing with intent. (Note: 6-8 in source docs, this generator stops at 4-6 so focuses on the earlier parts of this range)."
    };

    // --- Utility Functions (Ensure these are globally accessible or passed correctly) ---
    function getRandomElement(arr) {
        if (!arr || arr.length === 0) return "";
        return arr[Math.floor(Math.random() * arr.length)];
    }
    
    const CASEL_COMPETENCIES_MAP = { // As defined previously
        "Working Memory": ["Self-Management", "Responsible Decision-Making"],
        "Inhibition (Impulse Control)": ["Self-Management", "Relationship Skills"],
        "Cognitive Flexibility": ["Social Awareness", "Responsible Decision-Making", "Self-Management"],
        "Planning and Organization": ["Self-Management", "Responsible Decision-Making"],
        "Emotional Regulation (EF)": ["Self-Awareness", "Self-Management"],
        "Initiation": ["Self-Management", "Responsible Decision-Making"],
        "Self-Monitoring (EF)": ["Self-Awareness", "Responsible Decision-Making", "Self-Management"],
        "Time Management": ["Self-Management", "Responsible Decision-Making"],
        "Social Skills": ["Social Awareness", "Relationship Skills"],
        "Emotional Regulation (BS)": ["Self-Awareness", "Self-Management", "Relationship Skills"],
        "Self-Monitoring (BS)": ["Self-Awareness", "Responsible Decision-Making", "Self-Management"],
        "Impulse Control (BS)": ["Self-Management", "Relationship Skills"],
        "Adaptive Behavior": ["Self-Management", "Responsible Decision-Making", "Social Awareness"],
        "Communication Skills": ["Relationship Skills", "Social Awareness"],
        "Conflict Resolution": ["Relationship Skills", "Responsible Decision-Making", "Social Awareness"],
        "Attention and Focus": ["Self-Management"]
    };

    function getAssociatedSECompetencies(skill) {
        return CASEL_COMPETENCIES_MAP[skill] || ["Self-Management"]; 
    }

    function generateUniqueSkillName(skill) { 
        if (!skill) return "";
        let displayName = skill;
        if (skill.includes("(EF)")) displayName = skill.replace(" (EF)", " (Executive Functioning)");
        else if (skill.includes("(BS)")) { 
            if (skill === "Emotional Regulation (BS)") displayName = "Behavioral Emotional Regulation";
            else if (skill === "Self-Monitoring (BS)") displayName = "Behavioral Self-Monitoring";
            else if (skill === "Impulse Control (BS)") displayName = "Behavioral Impulse Control";
            else displayName = skill.replace(" (BS)", " (Behavioral)"); 
        }
        else if (skill === "Inhibition (Impulse Control)") displayName = "Inhibition (EF Impulse Control)";
        return displayName;
    }
    
    function generateSkillList(skillsRaw) { 
        const skills = [...new Set(skillsRaw.map(s => generateUniqueSkillName(s)).filter(Boolean))];
        if (skills.length === 0) return "selected focus areas";
        if (skills.length === 1) return skills[0];
        if (skills.length === 2) return skills.join(' and ');
        return skills.slice(0, -1).join(', ') + ', and ' + skills.slice(-1);
    }

    // --- Core Script Logic ---
    try { // Wrap the entire DOMContentLoaded logic in a try-catch for very early errors
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DEBUG: DOM Content Loaded. Initializing script...");

            // Element selectors
            const generateButton = document.getElementById('generateButton');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsDiv = document.getElementById('results');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessageDiv = document.getElementById('error-message');
            const printButton = document.getElementById('printButton');
            const skillTooltip = document.getElementById('skillTooltip'); // Correctly defined here

            const gradeLevelSelect = document.getElementById('gradeLevel');
            const numWeeksSelect = document.getElementById('numWeeks');
            const lessonsPerWeekSelect = document.getElementById('lessonsPerWeek');
            const primarySkill1Select = document.getElementById('primarySkill1');
            const primarySkill2Select = document.getElementById('primarySkill2');
            const studentInterestsInput = document.getElementById('studentInterests');
            
            const efSkillsContainer = document.getElementById('efSkillsContainer');
            const behSkillsContainer = document.getElementById('behSkillsContainer');

            console.log("DEBUG: efSkillsContainer element:", efSkillsContainer);
            console.log("DEBUG: behSkillsContainer element:", behSkillsContainer);

            // Ensure skillTooltip is found for tooltip functions
            if (!skillTooltip) {
                console.error("DEBUG: CRITICAL - Skill Tooltip element ('skillTooltip') NOT FOUND. Tooltips will fail.");
            }


            function populateSkillCheckboxes(container, skills, groupName, colorClass) {
                if (!container) {
                    console.error(`DEBUG: Container for ${groupName} is null or undefined. Cannot populate checkboxes.`);
                    // Try to inject an error message directly if the container ID exists but element isn't found as expected
                    const errorContainer = document.getElementById(container === efSkillsContainer ? 'efSkillsContainer' : 'behSkillsContainer');
                    if(errorContainer) {
                         errorContainer.innerHTML = `<p style="color: red; font-weight: bold;">Error: Could not find container for ${groupName}.</p>`;
                    }
                    return;
                }
                console.log(`DEBUG: Populating checkboxes for ${groupName} in container:`, container);
                // TEST 1: Simple paragraph injection
                // container.innerHTML = `<p style="color: green; font-weight: bold;">Test content for ${groupName} - Container Found!</p>`;
                // return; // Uncomment this line and the one above to test ONLY paragraph injection

                container.innerHTML = ''; // Clear any existing content to prevent duplication
                if (!skills || skills.length === 0) {
                    console.warn(`DEBUG: No skills provided for ${groupName}.`);
                    container.innerHTML = `<p>No skills to display for ${groupName}.</p>`;
                    return;
                }

                try {
                    skills.forEach((skill, index) => {
                        // console.log(`DEBUG: Creating checkbox for ${groupName} skill ${index + 1}:`, skill.value);
                        const label = document.createElement('label');
                        label.className = `flex items-center space-x-3 p-2 rounded-md hover:bg-${colorClass}-50 transition-colors duration-150`;
                        
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.name = groupName;
                        input.value = skill.value;
                        input.id = `${groupName}_${index}`; // Unique ID for label association
                        input.className = `form-checkbox h-5 w-5 text-${colorClass}-600 border-slate-400 rounded focus:ring-${colorClass}-500`;
                        input.addEventListener('change', updatePrimarySkillDropdowns);

                        const span = document.createElement('span');
                        span.className = 'text-slate-700';
                        span.textContent = skill.display;
                        span.setAttribute('for', input.id); // Associate span with checkbox

                        const tooltipTrigger = document.createElement('span');
                        tooltipTrigger.className = 'tooltip-trigger';
                        tooltipTrigger.textContent = '?';
                        tooltipTrigger.setAttribute('data-skill', skill.value);
                        tooltipTrigger.setAttribute('tabindex', '0'); 

                        label.appendChild(input);
                        label.appendChild(span);
                        label.appendChild(tooltipTrigger);
                        container.appendChild(label);
                    });
                } catch (e) {
                    console.error(`DEBUG: Error during creation of checkbox items for ${groupName}:`, e);
                    container.innerHTML = `<p style="color: red;">Error loading skills for ${groupName}. Details in console.</p>`;
                }
                console.log(`DEBUG: Checkboxes for ${groupName} populated. Attaching tooltip listeners...`);
                // Add tooltip listeners AFTER checkboxes are created
                container.querySelectorAll('.tooltip-trigger').forEach(trigger => {
                    trigger.addEventListener('mouseenter', showTooltip);
                    trigger.addEventListener('mouseleave', hideTooltip);
                    trigger.addEventListener('focus', showTooltip);
                    trigger.addEventListener('blur', hideTooltip);
                    trigger.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        if (skillTooltip.classList.contains('visible') && skillTooltip.dataset.currentTrigger === trigger.dataset.skill) {
                            hideTooltip();
                        } else {
                            showTooltip.call(trigger, e); 
                        }
                    });
                });
                 console.log(`DEBUG: Tooltip listeners for ${groupName} attached.`);
            }
            
            // Populate checkboxes
            if (efSkillsContainer) {
                 populateSkillCheckboxes(efSkillsContainer, ALL_EF_SKILLS, 'efSkills', 'sky');
            } else {
                console.error("DEBUG: EF Skills Container (efSkillsContainer) NOT FOUND in DOM. Checkboxes cannot be populated.");
            }
            if (behSkillsContainer) {
                populateSkillCheckboxes(behSkillsContainer, ALL_BEH_SKILLS, 'behSkills', 'rose');
            } else {
                console.error("DEBUG: Behavior Skills Container (behSkillsContainer) NOT FOUND in DOM. Checkboxes cannot be populated.");
            }
            
            updatePrimarySkillDropdowns(); // Initial call

            function updatePrimarySkillDropdowns() {
                console.log("DEBUG: Updating primary skill dropdowns...");
                // Fetch checkboxes dynamically each time this runs
                const currentEfSkillsCheckboxes = efSkillsContainer ? Array.from(efSkillsContainer.querySelectorAll('input[name="efSkills"]')) : [];
                const currentBehSkillsCheckboxes = behSkillsContainer ? Array.from(behSkillsContainer.querySelectorAll('input[name="behSkills"]')) : [];

                const selectedSkills = [...currentEfSkillsCheckboxes, ...currentBehSkillsCheckboxes]
                                         .filter(cb => cb.checked)
                                         .map(cb => ({ value: cb.value, text: generateUniqueSkillName(cb.value) }));

                [primarySkill1Select, primarySkill2Select].forEach(select => {
                    if (!select) {
                        console.warn("DEBUG: A primary skill select element is missing during update.");
                        return;
                    }
                    const currentlySelectedValue = select.value; 
                    select.innerHTML = '<option value="">-- None --</option>'; 
                    let currentStillValid = false;
                    selectedSkills.forEach(skill => {
                        const option = document.createElement('option');
                        option.value = skill.value; 
                        option.textContent = skill.text; 
                        select.appendChild(option);
                        if (skill.value === currentlySelectedValue) {
                            currentStillValid = true;
                        }
                    });
                    if(currentStillValid) {
                        select.value = currentlySelectedValue;
                    } else {
                        select.value = ""; // Reset if previous selection is no longer valid
                    }
                });
                 console.log("DEBUG: Primary skill dropdowns updated.");
            }
            
            function showTooltip(event) { 
                const trigger = event.currentTarget; 
                const skillKey = trigger.dataset.skill;
                const definition = SKILL_DEFINITIONS[skillKey] || "No definition available.";
                
                if (!skillTooltip) { console.error("DEBUG: Skill tooltip element not found in showTooltip!"); return; }

                skillTooltip.innerHTML = `<strong>${generateUniqueSkillName(skillKey)}:</strong><br>${definition}`;
                skillTooltip.dataset.currentTrigger = skillKey; 

                const rect = trigger.getBoundingClientRect();
                let leftPos = rect.left + window.scrollX;
                let topPos = rect.bottom + window.scrollY + 5;
                
                skillTooltip.style.left = `${leftPos}px`;
                skillTooltip.style.top = `${topPos}px`; 
                
                skillTooltip.classList.add('visible'); 
                const tooltipRect = skillTooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth) {
                    skillTooltip.style.left = `${window.innerWidth - tooltipRect.width - 10 + window.scrollX}px`;
                }
                if (tooltipRect.left < 0) {
                    skillTooltip.style.left = `${10 + window.scrollX}px`;
                }
                 if (tooltipRect.bottom > (window.innerHeight -10) && tooltipRect.height < rect.top) { 
                     skillTooltip.style.top = `${rect.top + window.scrollY - tooltipRect.height - 5}px`;
                }
            }

            function hideTooltip() {
                if (skillTooltip) {
                   skillTooltip.classList.remove('visible');
                   delete skillTooltip.dataset.currentTrigger;
                }
            }

            document.addEventListener('click', (e) => { 
                if (skillTooltip && skillTooltip.classList.contains('visible')) {
                    if (!skillTooltip.contains(e.target) && e.target && !e.target.classList.contains('tooltip-trigger')) {
                        hideTooltip();
                    }
                }
            });
            
            if (printButton) { 
                printButton.addEventListener('click', () => { window.print(); }); 
            } else { console.error("DEBUG: Print button not found");}

            if (generateButton) {
                generateButton.addEventListener('click', () => {
                    console.log("DEBUG: Generate button clicked.");
                    const gradeLevel = gradeLevelSelect.value;

                    const currentEfSkillsCheckboxes = efSkillsContainer ? Array.from(efSkillsContainer.querySelectorAll('input[name="efSkills"]')) : [];
                    const currentBehSkillsCheckboxes = behSkillsContainer ? Array.from(behSkillsContainer.querySelectorAll('input[name="behSkills"]')) : [];
                    const selectedEfSkills = currentEfSkillsCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
                    const selectedBehSkills = currentBehSkillsCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
                    const allSelectedSkillsRaw = [...selectedEfSkills, ...selectedBehSkills];
                    
                    console.log("DEBUG: Selected EF Skills:", selectedEfSkills);
                    console.log("DEBUG: Selected Beh Skills:", selectedBehSkills);

                    if (allSelectedSkillsRaw.length === 0) {
                        if (errorMessageDiv) { errorMessageDiv.classList.remove('hidden'); } 
                        else { alert("Please select at least one skill area."); }
                        if (resultsContainer) resultsContainer.classList.add('hidden');
                        if (loadingIndicator) loadingIndicator.classList.add('hidden');
                        console.log("DEBUG: No skills selected. Aborting generation.");
                        return;
                    }
                    
                    const userNumWeeks = parseInt(numWeeksSelect.value);
                    const userLessonsPerWeek = parseInt(lessonsPerWeekSelect.value);
                    const primarySkill1 = primarySkill1Select.value;
                    const primarySkill2 = primarySkill2Select.value;
                    const primarySkills = [primarySkill1, primarySkill2].filter(Boolean);

                    const studentInterestsRaw = studentInterestsInput.value.trim();
                    const studentInterests = studentInterestsRaw ? studentInterestsRaw.split(',').map(interest => interest.trim().toLowerCase()).filter(interest => interest !== "") : [];

                    const preferredModalitiesCheckboxes = document.querySelectorAll('input[name="teachingModalities"]:checked');
                    const preferredModalities = Array.from(preferredModalitiesCheckboxes).map(cb => cb.value);
                    
                    console.log("DEBUG: Inputs gathered. Starting generation process...");

                    if (errorMessageDiv) errorMessageDiv.classList.add('hidden');
                    if (resultsContainer) resultsContainer.classList.add('hidden');
                    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                    if (resultsDiv) resultsDiv.innerHTML = ''; 

                    setTimeout(() => {
                        try {
                            const unitPlan = generateUnitPlanContent(gradeLevel, selectedEfSkills, selectedBehSkills, userNumWeeks, userLessonsPerWeek, primarySkills, studentInterests, preferredModalities);
                            if (resultsDiv) resultsDiv.innerHTML = unitPlan;
                            if (loadingIndicator) loadingIndicator.classList.add('hidden');
                            if (resultsContainer) {
                                resultsContainer.classList.remove('hidden');
                                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                            }
                            console.log("DEBUG: Unit plan generation complete.");
                        } catch (error) {
                            console.error("DEBUG: Error during unit plan generation:", error.stack); // Log stack trace
                            if (resultsDiv) resultsDiv.innerHTML = "<p class='text-red-500'>An error occurred generating the unit plan: " + error.message + ". Please check the browser console for more details.</p>";
                            if (loadingIndicator) loadingIndicator.classList.add('hidden');
                            if (resultsContainer) resultsContainer.classList.remove('hidden');
                        }
                    }, 100); // Reduced timeout for quicker feedback
                });
            } else { console.error("DEBUG: Generate button not found");}

            // --- Main Content Generation Functions (with enhancements) ---
            // These functions (generateUnitPlanContent, generateSessionContent, getMaterials, getWarmUp, etc.)
            // should be the versions from the previous "Corrected" response, as they contained the enhancements.
            // For brevity here, I'm not re-pasting all of them, but assume they are the fully enhanced versions.
            // Ensure they are defined correctly here in the actual implementation.
            // START of previously provided enhanced functions (abbreviated here for clarity of focus on the fix)
            function generateUnitPlanContent(gradeLevel, efSkills, behSkills, numWeeks, lessonsPerWeekCount, primarySkills, studentInterests, preferredModalities) {
                console.log("DEBUG: generateUnitPlanContent called with:", gradeLevel, efSkills, behSkills, numWeeks, lessonsPerWeekCount, primarySkills, studentInterests, preferredModalities);
                const allSelectedSkillsRaw = [...efSkills, ...behSkills];
                
                let html = ``;
                const primarySkillForTitle = primarySkills.length > 0 ? generateUniqueSkillName(primarySkills[0]) : (allSelectedSkillsRaw.length > 0 ? generateUniqueSkillName(allSelectedSkillsRaw[0]) : "Key");
                let interestThemeTitleSegment = "";
                if (studentInterests.length > 0) {
                    const capitalizedInterests = studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1));
                    interestThemeTitleSegment = ` with a Focus on ${capitalizedInterests.join(' & ')} Themes`;
                }
                html += `<h2 class="text-2xl font-bold text-sky-700 mb-3">Unit Title: Strengthening ${primarySkillForTitle} and Related SEL Skills${interestThemeTitleSegment}</h2>`;
                
                html += `<p><strong>Grade Range:</strong> ${gradeLevel}</p>`;
                html += `<p><strong>Focus Executive Functioning Skills:</strong> ${efSkills.length > 0 ? generateSkillList(efSkills) : "None selected"}</p>`;
                html += `<p><strong>Focus Behavioral Skills:</strong> ${behSkills.length > 0 ? generateSkillList(behSkills) : "None selected"}</p>`;
                if (primarySkills.length > 0) {
                    html += `<p><strong>Primary Focus Skill(s):</strong> ${generateSkillList(primarySkills)}</p>`;
                }
                if (studentInterests.length > 0) {
                    html += `<p><strong>Student Interests Considered:</strong> ${studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(', ')}</p>`;
                }
                if (preferredModalities.length > 0) {
                    html += `<p><strong>Preferred Teaching Modalities Considered:</strong> ${preferredModalities.map(m => m.replace(/([A-Z0-9])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim()).join(', ')}</p>`;
                }

                const allSelCompetenciesForUnit = [...new Set(allSelectedSkillsRaw.flatMap(skill => getAssociatedSECompetencies(skill)))];
                html += `<p><strong>Associated SEL Competencies:</strong> ${allSelCompetenciesForUnit.join(', ')}</p>`;
                html += `<p><strong>Duration:</strong> ${numWeeks} weeks (${lessonsPerWeekCount} sessions per week, approx. 30 min each)</p>`;
                const developmentalNoteForGrade = DEVELOPMENTAL_NOTES[gradeLevel] || "Ensure activities are developmentally appropriate for the selected grade range.";
                html += `<p class="text-sm italic text-slate-500 mt-1"><strong>Developmental Note (${gradeLevel}):</strong> ${developmentalNoteForGrade}</p>`;


                html += `<h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">Unit Overview & Outcomes</h3>`;
                const focusSkillsText = generateSkillList(allSelectedSkillsRaw);
                const overviewInterestsText = studentInterests.length > 0 ? studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(', ') : 'various engaging themes';
                html += `<p>This ${numWeeks}-week unit focuses on developing students' ${focusSkillsText}. Executive functioning and behavioral skills are crucial for academic success, social-emotional well-being, and effective self-regulation. This unit aims to enhance these abilities through targeted activities that are engaging, developmentally appropriate for students in ${gradeLevel}, and incorporates student interests like ${overviewInterestsText}. ${primarySkills.length > 0 ? `Special emphasis will be placed on ${generateSkillList(primarySkills)}.` : ''}</p>`;
                html += `<p><strong>Key Outcomes:</strong> By the end of this unit, students will be better able to:</p>
                            <ul class="list-disc list-inside pl-4 text-sm">
                                <li>Understand the importance of ${focusSkillsText.toLowerCase()} in daily life, including how they relate to their interests.</li>
                                <li>Apply practical strategies related to ${focusSkillsText.toLowerCase()} in classroom and social settings, using preferred learning styles where possible.</li>
                                <li>Demonstrate growth in associated Social-Emotional Learning (SEL) competencies such as ${allSelCompetenciesForUnit.join(', ').toLowerCase()}.</li>
                                <li>Reflect on their own skill development and identify areas for continued practice.</li>
                            </ul>`;

                let availableSkillsForRotation = [...allSelectedSkillsRaw];
                if (primarySkills.length > 0) { 
                    availableSkillsForRotation = [...primarySkills, ...allSelectedSkillsRaw.filter(s => !primarySkills.includes(s))];
                }
                
                for (let i = 1; i <= numWeeks; i++) { 
                    html += `<div class="mt-6 pt-4 border-t border-slate-300 page-break">`; 
                    let weeklyThemeSkillsRaw = [];
                    
                    if (availableSkillsForRotation.length > 0) {
                        weeklyThemeSkillsRaw.push(availableSkillsForRotation[ ( (i-1) * 2 ) % availableSkillsForRotation.length]);
                        if (availableSkillsForRotation.length > 1 && weeklyThemeSkillsRaw.length < 2) {
                            let secondSkillCandidate = availableSkillsForRotation[ ( (i-1) * 2 + 1) % availableSkillsForRotation.length];
                            if (secondSkillCandidate !== weeklyThemeSkillsRaw[0]) { // ensure not same as first if possible
                                weeklyThemeSkillsRaw.push(secondSkillCandidate);
                            } else if (availableSkillsForRotation.length > 2) { // try to get a third different one
                                weeklyThemeSkillsRaw.push(availableSkillsForRotation[ ( (i-1) * 2 + 2) % availableSkillsForRotation.length]);
                            }
                        }
                    }
                    if (weeklyThemeSkillsRaw.length === 0 && allSelectedSkillsRaw.length > 0) weeklyThemeSkillsRaw.push(allSelectedSkillsRaw[0]); 
                    weeklyThemeSkillsRaw = [...new Set(weeklyThemeSkillsRaw)]; 


                    const weeklyThemeSkillsText = generateSkillList(weeklyThemeSkillsRaw);
                    html += `<h4 class="text-lg font-semibold text-sky-600 mb-1">Week ${i}: Focusing on ${weeklyThemeSkillsText}</h4>`;
                    let weeklyInterest = studentInterests.length > 0 ? studentInterests[(i-1) % studentInterests.length] : "engaging topics";
                    html += `<p class="italic text-sm text-slate-600 mb-3">This week, activities will center on understanding and practicing ${weeklyThemeSkillsText.toLowerCase()}, linking them to relevant classroom situations, SEL growth, and possibly themes related to ${weeklyInterest}.</p>`;

                    for (let j = 1; j <= lessonsPerWeekCount; j++) { 
                        let lessonFocusSkillRaw = "";
                        if (weeklyThemeSkillsRaw.length > 0) {
                            lessonFocusSkillRaw = weeklyThemeSkillsRaw[(j-1) % weeklyThemeSkillsRaw.length];
                        } else if (allSelectedSkillsRaw.length > 0) {
                            lessonFocusSkillRaw = allSelectedSkillsRaw[( (i-1) * lessonsPerWeekCount + (j-1) ) % allSelectedSkillsRaw.length];
                        }
                        if (!lessonFocusSkillRaw && allSelectedSkillsRaw.length > 0) lessonFocusSkillRaw = allSelectedSkillsRaw[0]; 
                        if (!lessonFocusSkillRaw) lessonFocusSkillRaw = "a key skill";
                        
                        html += generateSessionContent(lessonFocusSkillRaw, gradeLevel, i, j, allSelectedSkillsRaw, studentInterests, preferredModalities);
                    }
                    html += `</div>`;
                }

                html += `<div class="mt-8 pt-6 border-t border-slate-300 page-break">`;
                html += `<h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">General Integration Ideas (Throughout the Unit)</h3>`;
                html += generateIntegrationIdeas(allSelectedSkillsRaw, gradeLevel, studentInterests);
                html += `</div>`;

                html += `<div class="mt-8 pt-6 border-t border-slate-300">`;
                html += `<h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">Progress Monitoring & Assessment Ideas</h3>`;
                html += generateProgressMonitoringTips(allSelectedSkillsRaw, gradeLevel, studentInterests);
                html += `</div>`;
                
                return html;
            }

            function generateSessionContent(rawSkill, gradeLevel, weekNum, lessonNum, allSelectedSkillsRaw, studentInterests, preferredModalities) { 
                const skillName = generateUniqueSkillName(rawSkill);
                const selCompetencies = getAssociatedSECompetencies(rawSkill);
                let sessionHtml = `<div class="ml-0 md:ml-4 mt-4 p-4 bg-white rounded shadow-md border border-slate-200">`;
                sessionHtml += `<h5 class="text-md font-semibold text-slate-800 mb-2">Week ${weekNum}, Session ${lessonNum} - Focus Skill: ${skillName}</h5>`;
                
                const interestsForObjective = studentInterests.length > 0 ? getRandomElement(studentInterests) : 'everyday tasks';
                const capInterestForObjective = interestsForObjective.charAt(0).toUpperCase() + interestsForObjective.slice(1);
                const modalitiesForObjective = preferredModalities.length > 0 ? preferredModalities.map(m => m.replace(/([A-Z0-9])/g, ' $1').toLowerCase().trim()).join(' or ') : 'varied';

                sessionHtml += `<h6>Learning Objectives:</h6><ul class="list-disc list-inside pl-4 text-sm">`;
                sessionHtml += `<li>Students will be able to define or describe ${skillName.toLowerCase()} and identify one way it is used, possibly in relation to ${capInterestForObjective}.</li>`;
                sessionHtml += `<li>Students will practice ${selCompetencies[0].toLowerCase()} by engaging in the session activities, potentially using ${modalitiesForObjective} learning approaches.</li></ul>`;

                const materials = getMaterials(rawSkill, gradeLevel, preferredModalities);
                sessionHtml += `<h6>Materials Needed:</h6><p class="text-sm">${materials.join(', ') || "Basic classroom supplies."}</p>`;
                
                sessionHtml += `<h6>Warm-Up (Approx. 5 minutes):</h6><p class="text-sm">${getWarmUp(rawSkill, gradeLevel, weekNum, lessonNum, studentInterests, preferredModalities)}</p>`;

                sessionHtml += `<h6>Mini-Lesson & Discussion (Approx. 5-7 minutes):</h6><p class="text-sm">${getMiniLesson(rawSkill, gradeLevel, selCompetencies, studentInterests)}</p>`;
                
                const coreActivity = getCoreActivity(rawSkill, gradeLevel, selCompetencies, allSelectedSkillsRaw, studentInterests, preferredModalities);
                sessionHtml += `<h6>Core Activity: ${coreActivity.title} (Approx. 15-20 minutes)</h6>
                                <p class="text-sm">${coreActivity.description}</p>
                                <ol class="list-decimal list-inside pl-4 text-sm space-y-1">`;
                coreActivity.steps.forEach(step => { sessionHtml += `<li>${step}</li>`;});
                sessionHtml += `</ol>`;
                if (coreActivity.differentiation) {
                    sessionHtml += `<p class="text-xs italic mt-1">Differentiation Ideas: ${coreActivity.differentiation}</p>`;
                }

                sessionHtml += `<h6>Wrap-up & Reflection (Approx. 5 minutes):</h6><p class="text-sm">${getReflection(rawSkill, gradeLevel, selCompetencies, studentInterests, preferredModalities)}</p>`;

                const closing = getClosing(rawSkill, gradeLevel, studentInterests);
                if (closing) {
                    sessionHtml += `<h6>Closing & Home Connection Idea (Optional, 1-2 minutes):</h6><p class="text-sm">${closing}</p>`;
                }
                
                const teacherTip = getTeacherTip(rawSkill, gradeLevel, preferredModalities, allSelectedSkillsRaw, studentInterests);
                if (teacherTip) {
                    sessionHtml += `<p class="text-xs italic mt-2 p-2 bg-sky-50 rounded"><strong>Teacher Tip:</strong> ${teacherTip}</p>`;
                }

                sessionHtml += `</div>`;
                return sessionHtml;
            }
            // ... (Rest of the enhanced getMaterials, getWarmUp, getMiniLesson, getCoreActivity, getReflection, getClosing, getTeacherTip, generateIntegrationIdeas, generateProgressMonitoringTips functions from the previous response)
            // For brevity, I am not re-pasting ALL of them here but they should be the full enhanced versions.
            // Make sure to include the FULL enhanced versions of these functions here.
            // Example of where the functions would continue:
            function getMaterials(skill, gradeLevel, preferredModalities = []) {
                let materials = ["Whiteboard or chart paper", "Markers or pens", "Paper", "Pencils or crayons"];
                if (skill.includes("Time Management") || skill.includes("Planning")) materials.push("Timer (visual for K-2)", "Sample checklists or graphic organizers");
                if (skill.includes("Emotional Regulation")) materials.push("Feeling faces chart/cards", "Breathing exercise visual (e.g., 'starfish breathing')", "Role-play scenario cards");
                if (skill.includes("Working Memory")) materials.push("Picture cards", "Small objects for memory games", "List of multi-step directions");
                if (gradeLevel === "4-6" && (skill.includes("Organization") || skill.includes("Self-Monitoring"))) materials.push("Student journals/notebooks", "Highlighters");
                if (skill.includes("Cognitive Flexibility")) materials.push("Problem-solving scenario cards", "Building materials (e.g. blocks, craft supplies)");
                
                if (preferredModalities.includes('artsCrafts')) {
                    materials.push("Art supplies (colored paper, scissors, glue, play-doh, yarn)");
                }
                if (preferredModalities.includes('techIntegration')) {
                    materials.push("Access to tablets or computers (if applicable and available)");
                }
                if (preferredModalities.includes('storytellingDrama')) {
                    materials.push("Simple props or costumes (optional, e.g., hats, scarves)");
                }
                return [...new Set(materials)];
            }

            function getWarmUp(skill, gradeLevel, weekNum, lessonNum, studentInterests = [], preferredModalities = []) {
                const skillName = generateUniqueSkillName(skill);
                let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "a fun topic";
                let capRandomInterest = randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1);
                
                const warmups = [
                    `Quick Review: "Last session, we talked about [concept, e.g., 'listening with our whole body']. Who remembers one way that helps us, maybe when learning about ${capRandomInterest}?"`,
                    `Mindful Moment: Lead a 1-minute 'Mindful Listening' exercise (e.g., "Listen for all the sounds you can hear inside/outside for 30 seconds") or 'Flower & Candle Breathing'. (SEL: Self-Awareness/Self-Management).`,
                    `Brain Teaser: A simple ${capRandomInterest}-themed riddle or 'What am I?' game related to classroom objects. (EF: Attention/Working Memory).`,
                    `"Feelings Check-in": Students use thumbs up/middle/down to show how they are feeling, or choose a 'feeling word' from a list. (SEL: Self-Awareness).`
                ];
                if (gradeLevel === "K-1") {
                    warmups.push(`Sing a short, active song like "Head, Shoulders, Knees, and Toes" and then ask, "What part of our body helps us use ${skillName.toLowerCase()} when we play with ${capRandomInterest}?"`);
                } else if (gradeLevel === "2-3") {
                    warmups.push(`"One-Word Whip Around": Students share one word that describes what ${skillName.toLowerCase()} means to them, or one word about ${capRandomInterest}.`);
                } else { // 4-6
                    warmups.push(`"Quick Write/Draw": Students jot down or sketch one challenge they sometimes face related to ${skillName.toLowerCase()} when working on ${capRandomInterest} or school projects. (No sharing necessary initially).`);
                }

                if (preferredModalities.includes('movementKinesthetic')) { 
                    warmups.unshift(`Active Start: A quick "Body Brainstorm" - "Show me with your body what it looks like to be a good planner for a ${capRandomInterest} adventure!" or "Shake out the wiggles then find a 'ready to learn' pose." Helps with ${skillName} by preparing the brain and body.`);
                }
                return getRandomElement(warmups);
            }

            function getMiniLesson(skill, gradeLevel, selCompetencies, studentInterests = []) {
                const skillName = generateUniqueSkillName(skill);
                const selText = selCompetencies.join(' and ').toLowerCase();
                let interestExample = "";
                let randomInterest = "";
                if (studentInterests && studentInterests.length > 0) {
                    randomInterest = getRandomElement(studentInterests);
                    let capRandomInterest = randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1);
                    interestExample = ` For instance, if you love ${capRandomInterest}, using good ${skillName.toLowerCase()} can help you learn new facts, create amazing ${capRandomInterest} stories, or work with a friend on a ${capRandomInterest} game!`;
                }
                const definition = SKILL_DEFINITIONS[skill] || `our ability to effectively manage our actions and thoughts for this skill`;
                
                let intro = `Today we're putting on our **${skillName}** thinking caps! ${skillName} is about ${definition.toLowerCase()} This is a super skill because it helps us do well in school, make friends, and even get better at things we enjoy like ${randomInterest || "our hobbies"}. When we strengthen our ${skillName.toLowerCase()}, we're also boosting our SEL skills like ${selText}.${interestExample}`;
                
                let exampleOrStrategy = "";
                let capRandomInterestForExample = randomInterest ? randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1) : "something cool";

                if (gradeLevel === "K-1") {
                    let K1_interest_ex = `remembering the rules for a ${capRandomInterestForExample} game or listening to a story about ${capRandomInterestForExample}.`;
                    exampleOrStrategy = `Think about ${K1_interest_ex} That's using our ${skillName.toLowerCase()}! A simple way to practice is to use "listening ears" and "quiet hands."`;
                } else if (gradeLevel === "2-3") {
                    let G23_interest_ex = `planning the steps to build a ${capRandomInterestForExample} model or figuring out how to share ideas for a ${capRandomInterestForExample} group poster.`;
                    exampleOrStrategy = `Imagine ${G23_interest_ex} You need ${skillName.toLowerCase()} to think about the steps or talk things through. A strategy is to "Stop, Think, Plan" or "Take Turns Talking."`;
                } else { // 4-6
                    let G46_interest_ex = `organizing a research project about ${capRandomInterestForExample}, managing your time to finish a ${capRandomInterestForExample}-themed assignment, or solving a tricky problem in a ${capRandomInterestForExample} computer game.`;
                    exampleOrStrategy = `Consider ${G46_interest_ex}. Strong ${skillName.toLowerCase()} skills help you break down big tasks, use tools like checklists, and stay focused. We can also use strategies like "self-talk" to guide our thinking. How does using ${skillName.toLowerCase()} help you be a responsible and successful learner (SEL)?`;
                }
                return intro + ` ${exampleOrStrategy} Let's brainstorm: When was a time this week you used (or could have used) ${skillName.toLowerCase()}? How did it feel?`;
            }
            
            function getCoreActivity(skill, gradeLevel, selCompetencies, allSelectedSkillsRaw, studentInterests = [], preferredModalities = []) {
                const skillName = generateUniqueSkillName(skill);
                const selText = selCompetencies[0].toLowerCase();
                let activity = { title: `Strengthening Our ${skillName}`, description: `Let's dive into an activity to actively build our ${skillName.toLowerCase()} and practice ${selText} (SEL).`, steps: ["Follow teacher's instructions.", "Participate respectfully.", "Reflect on your experience."], differentiation: "Adjust complexity based on student responses." };
                let interestFlavor = studentInterests.length > 0 ? getRandomElement(studentInterests) : "";
                let interestPrefix = interestFlavor ? `${interestFlavor.charAt(0).toUpperCase() + interestFlavor.slice(1)}-Themed ` : "";
                let devNote = DEVELOPMENTAL_NOTES[gradeLevel] ? `(Developmental note: ${DEVELOPMENTAL_NOTES[gradeLevel].split('.')[0]})` : "";

                let chosenActivityType = "";
                const activityTypePreferences = {
                    "Working Memory": "Game", "Inhibition (Impulse Control)": "Game", "Cognitive Flexibility": "Problem-Solving Task", 
                    "Planning and Organization": "Strategy Instruction", "Emotional Regulation (EF)": "Role-Play", "Initiation": "Strategy Instruction", 
                    "Self-Monitoring (EF)": "Strategy Instruction", "Time Management": "Strategy Instruction", "Social Skills": "Role-Play", 
                    "Emotional Regulation (BS)": "Role-Play", "Self-Monitoring (BS)": "Scenario Analysis", "Impulse Control (BS)": "Game", 
                    "Adaptive Behavior": "Hands-On Task/Project Intro", "Communication Skills": "Role-Play", "Conflict Resolution": "Role-Play", 
                    "Attention and Focus": "Game"
                };
                chosenActivityType = activityTypePreferences[skill] || "Hands-On Task/Project Intro";

                if (preferredModalities.includes('gameBased') && (chosenActivityType === "Game" || skill.includes("Memory") || skill.includes("Attention") || skill.includes("Impulse"))) chosenActivityType = "Game";
                else if (preferredModalities.includes('storytellingDrama') && (chosenActivityType === "Role-Play" || skill.includes("Social") || skill.includes("Communication") || skill.includes("Emotion"))) chosenActivityType = "Role-Play";
                else if (preferredModalities.includes('artsCrafts')) chosenActivityType = "Hands-On Task/Project Intro";
                else if (preferredModalities.includes('movementKinesthetic')) chosenActivityType = "MovementActivity";
                else if (preferredModalities.includes('discussionOriented') && gradeLevel === '4-6') chosenActivityType = "Case Study/Problem-Solving";


                if (skill.includes("Planning and Organization")) {
                    activity.title = `${interestPrefix}Super Planners: Mastering ${skillName}`;
                    activity.description = `Good ${skillName.toLowerCase()} helps us get things done, like finishing our ${interestFlavor || "school work"} or creating an awesome ${interestFlavor || "story"}! (SEL: ${selText}). ${devNote}`;
                    if (gradeLevel === "K-1") { // Guided Participant
                        activity.steps = [
                            `"Plan Our ${interestFlavor || "Art"} Time": As a class, plan 2-3 visual steps for a simple art project (e.g., making a ${interestFlavor || "caterpillar"} with circles: 1. Get circles. 2. Glue circles in a line. 3. Draw face and legs).`,
                            "Use large picture cards for each step. Teacher models and points to current step.",
                            `Sing a simple "planning song" (e.g., "First we get our stuff, then we make our art...") as you complete the steps.`,
                            "Admire the completed ${interestFlavor || "art"} and praise following the plan! 'You were great guided participants!'"
                        ];
                        activity.differentiation = `Focus on 2 very simple, sequential steps. Use concrete objects and direct modeling. Heavy teacher guidance.`;
                    } else if (gradeLevel === "2-3") { // Emerging Self-Manager
                        activity.steps = [
                            `"${interestPrefix}Mini-Adventure Plan": Task: 'Plan a 3-step treasure hunt for a small ${interestFlavor || "classroom item"} in a designated area.' or 'List the steps to teach someone how to build a simple ${interestFlavor || "block"} tower.'`,
                            "In pairs, students use a 'First, Next, Then' graphic organizer to list their steps.",
                            "Pairs share their plans with another pair. Did they miss any important steps? 'You're becoming flexible adapters with your plans!'",
                            `Discuss: How does making a plan help our ${interestFlavor || "adventure"} or building be more fun and successful?`
                        ];
                        activity.differentiation = `Provide a pre-filled template with some step ideas. Offer sentence starters. Allow drawing vs. writing for plans.`;
                    } else { // 4-6: Intentional Strategist / Reflective Adapter
                        activity.steps = [
                            `"The ${interestPrefix}Invention Design": Task: 'Design a new game or tool that would be helpful for ${interestFlavor || "students studying a topic"} (or for a ${interestFlavor || "favorite book character"}). Sketch it, list its key features, and outline the steps to explain how it works or how to build a simple model.'`,
                            "Students use a planning sheet: Goal -> Materials/Features -> Steps to Explain/Build -> Potential Problems & Solutions. 'Use your intentional strategist skills!'",
                            `Emphasize breaking the task into manageable parts, estimating time (briefly), and thinking ahead about challenges. How can you be a reflective adapter if your first idea doesn't work?`,
                            `Gallery walk: Students display their invention plans. They provide constructive feedback to 2 peers on clarity, completeness, and creativity of the plan.`
                        ];
                        activity.differentiation = `More open-ended tasks. Students can choose from different planning templates (e.g., flow chart, outline). Encourage self-monitoring of plan execution during a follow-up "build/present" session if time allows.`;
                    }
                } else if (skill.includes("Emotional Regulation (BS)")) {
                    activity.title = `${interestPrefix}Cool Down Crew: Managing Big Feelings Like a Pro`;
                    activity.description = `We all have big feelings! Today we'll practice how to handle them in helpful ways, especially when things feel tricky like during a tough ${interestFlavor || "assignment"} or when playing a ${interestFlavor || "game"}. (SEL: ${selText}). ${devNote}`;
                    let commonTriggers = gradeLevel === "K-1" ? `when a ${interestFlavor || "toy"} is taken or it's time to stop playing` : 
                                        gradeLevel === "2-3" ? `when we make a mistake on our ${interestFlavor || "writing"} or have a disagreement about ${interestFlavor || "game"} rules with a friend` :
                                        `when facing a challenging academic task, peer conflicts during a ${interestFlavor || "group project"}, or feeling overwhelmed by too much noise during ${interestFlavor || "independent work"}.`;
                    activity.steps = [
                        `"Feeling Forecasters & Body Clues": Discuss common situations (antecedents) that might make us feel frustrated, angry, or worried (e.g., ${commonTriggers}). How do our bodies tell us we're starting to feel a big emotion? (e.g., fast heart, tight fists). Use feeling faces or a feelings wheel.`,
                        `"My Cool Down Tool Kit": Introduce 1-2 simple, appropriate calming strategies (replacement behaviors). Examples: ${gradeLevel === "K-1" ? `'Smell the ${interestFlavor || "pizza"}, cool the soup' (deep breath)` : `'Turtle Time' (pull into shell, take breaths) or '5 Finger Starfish Breathing' for 2-3, or 'Mindful walk to get a drink' or 'Quick Squeeze & Release' (tense and relax muscles) for 4-6`}. Practice these when students are calm.`,
                        `"Strategy Scene - Act it Out!": Students role-play a scenario (e.g., "You're trying to build a tall ${interestFlavor || "block tower"} and it keeps falling. You start to feel very frustrated."). One student acts out feeling frustrated, another student (or teacher) prompts them to use a "Cool Down Tool." Then, they practice asking for help or a short break using polite words (e.g., 'I need a minute, please').`,
                        `Discuss: How did using the strategy feel? What's a respectful way to communicate you need a moment or help? (Reinforces teaching appropriate requesting skills).`
                    ];
                    activity.differentiation = `K-1: Focus on one strategy with highly visual aids and actions (e.g., puppet shows). Teacher leads role-play. 2-3: Offer a choice of 2 strategies, more peer-led role-play with simple scripts. 4-6: Students can generate their own scenarios related to ${interestFlavor || "their experiences"}, identify their personal triggers, and develop a personalized cool-down plan. Discuss different intensities of feelings and matching strategies.`;
                } else if (chosenActivityType === "MovementActivity") {
                    activity.title = `${interestPrefix}${skillName} Action Zone!`;
                    activity.description = `Let's get our bodies and brains working together to practice ${skillName.toLowerCase()}! (SEL: ${selText}) ${devNote}`;
                    activity.steps = [
                        `"Follow the ${interestFlavor || "Leader"} - Skill Twist!": Leader does actions, but sometimes gives a "skill cue" (e.g., for Inhibition: "Freeze if I touch my nose!"). Students must inhibit other actions.`,
                        `"${skillName} Obstacle Course Relay": Set up a simple course. Teams plan their strategy (Planning). Each member remembers a sequence of actions (Working Memory). They cheer for teammates (Social Skills) and wait their turn (Inhibition). Stations could be ${interestFlavor}-themed.`,
                        `Reflect: How did moving our bodies help us think about ${skillName.toLowerCase()}? Did you notice any other skills we used?`
                    ];
                    activity.differentiation = `K-1: Very simple movements, one-step instructions, focus on fun. 2-3: Two-step instructions, partner work. 4-6: More complex sequences, students can help design the course or challenges, time trials for older students focusing on efficiency and self-monitoring.`;
                }
                else { 
                    activity.title = `${interestPrefix}Skill Spotlight on: ${skillName}`;
                    activity.description = `This activity will help us explore and practice ${skillName.toLowerCase()} using ${interestFlavor || "fun and engaging examples"}. (SEL: ${selText}) ${devNote}`;
                    let exampleTask = `a short '${interestFlavor || "Memory"} March' game for Working Memory (remember a sequence of 3-4 actions), a 'What if this ${interestFlavor || "story"} character chose differently?' discussion for Cognitive Flexibility, or acting out how to ask to join a ${interestFlavor || "playground"} game for Social Skills.`;
                    activity.steps = [
                        `Introduce ${skillName.toLowerCase()} with a relatable example, perhaps involving ${interestFlavor || 'school tasks'}. "For instance, when you're trying to learn a new dance move for the ${interestFlavor || "school play"}, you need good ${skillName.toLowerCase()} to..."`,
                        `Engage in a brief, structured task focusing on the skill: ${exampleTask}`,
                        "Discuss: How did we use our ${skillName.toLowerCase()} skill? When else could this be helpful, maybe when working on ${interestFlavor || 'projects with friends'}?"
                    ];
                    activity.differentiation = `K-1: Use concrete materials, direct modeling, very short activities, lots of praise for effort. 2-3: Partner work, slightly longer tasks, simple written/drawn responses. 4-6: Small group problem-solving, apply to more complex academic or social scenarios, encourage students to generate their own examples.`;
                }
                
                if (preferredModalities.includes('artsCrafts') && chosenActivityType !== 'Hands-On Task/Project Intro') {
                    activity.differentiation += ` Art Connection: Students could draw a comic strip showing someone using the ${skillName.toLowerCase()} strategy effectively in a ${interestFlavor || "school situation"}, or create a small craft representing a key idea from the lesson.`;
                }
                if (preferredModalities.includes('storytellingDrama') && chosenActivityType !== 'Role-Play') {
                    activity.differentiation += ` Story/Drama Link: As a group, create a short story or a tableau (frozen scene) about a character (perhaps a ${interestFlavor || "curious explorer"}) who learns to use ${skillName.toLowerCase()} to solve a problem.`;
                }
                if (preferredModalities.includes('techIntegration')) {
                    activity.differentiation += ` Tech Idea: If appropriate and available, use a simple polling tool for quick reflections, or find a short educational video/interactive game that reinforces ${skillName.toLowerCase()} (related to ${interestFlavor || "a concept"} if possible).`;
                }

                return activity;
            }

            function getReflection(skill, gradeLevel, selCompetencies, studentInterests = [], preferredModalities = []) {
                const skillName = generateUniqueSkillName(skill);
                const selText = selCompetencies[0].toLowerCase(); 
                let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests).charAt(0).toUpperCase() + getRandomElement(studentInterests).slice(1) : "something you enjoy";
                let modalityUsed = preferredModalities.length > 0 ? `learning through ${preferredModalities.map(m=>m.replace(/([A-Z0-9])/g, ' $1').toLowerCase().trim()).join(' and ')}` : "today's activity";

                let questions = [
                    `"What was the main skill we worked on today (${skillName.toLowerCase()})? How did you use it during ${modalityUsed}, perhaps when we talked about ${randomInterest}?"`,
                    `"What was one part of our activity that made your brain think hard? What felt easier, and why do you think so?" (SEL: Self-Awareness)`,
                    `"How can using ${skillName.toLowerCase()} help you when you are learning about ${randomInterest}, working with classmates, or doing tasks at home?" (SEL: ${selText}, Responsible Decision-Making). This shows how these skills are useful everywhere!`,
                    `"What's one 'super strategy' or idea about ${skillName.toLowerCase()} you'll try to remember and use this week?" (Fostering generalization)`
                ];
                if (gradeLevel === "K-1") {
                    questions.push(`"Show me a 'brain signal' (e.g., tap head) if you tried your best with ${skillName.toLowerCase()} today! How can ${skillName.toLowerCase()} help us be good friends when playing with ${randomInterest || "toys"}?"`);
                } else if (gradeLevel === "2-3") {
                    questions.push(`"What's one new thing you learned or thought about ${skillName.toLowerCase()} or ${selText} today, especially from our ${modalityUsed} or discussions about ${randomInterest || "our topics"}? Share with a partner."`);
                } else { // 4-6
                    questions.push(`"On a scale of 1 to 3 'brain boosts' (1=still learning, 3=feeling strong), how do you feel about using ${skillName.toLowerCase()} after today? What's one thing that would help you get another 'brain boost' next time? How did ${modalityUsed} support or challenge your learning today?" (SEL: Self-Awareness, Self-Management)`);
                }
                return `Gather for a debrief. Use prompts like: ${getRandomElement(questions)} ${Math.random() > 0.5 ? getRandomElement(questions.filter(q => !q.includes("main skill we worked on"))) : ""}. Encourage sharing and connect back to real-world applications and student interests. Use 'turn and talk' for K-3, or a quick journal jot for 4-6 before sharing.`;
            }

            function getClosing(skill, gradeLevel, studentInterests = []) {
                const skillName = generateUniqueSkillName(skill);
                let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests).charAt(0).toUpperCase() + getRandomElement(studentInterests).slice(1) : "your favorite things";
                if (Math.random() < 0.9) { 
                    let closingPrompt = `Fantastic ${skillName.toLowerCase()} practice today, everyone! Your 'mission' is to spot ${skillName.toLowerCase()} in action this week – maybe when you're reading about ${randomInterest}, playing a game, or helping at home. Tell us about it next time!`;
                    if (gradeLevel === "K-1") closingPrompt = `Awesome effort! Remember to use your ${skillName.toLowerCase()} superpowers like a superhero, especially when you're exploring ${randomInterest}! Ask a grown-up to help you spot it, or draw a picture of you using the skill.`;
                    if (gradeLevel === "4-6") closingPrompt = `Excellent critical thinking and strategy use today. Next session, we'll build on ${skillName.toLowerCase()} by [mention next skill or application, e.g., 'applying it to a group research project about ${randomInterest}']. For home, try to teach someone in your family one strategy we learned for ${skillName.toLowerCase()}.`;
                    return closingPrompt;
                }
                return "";
            }
            
            function getTeacherTip(skill, gradeLevel, preferredModalities = [], allSelectedSkillsRaw = [], studentInterests = []) { // Added studentInterests
                const skillName = generateUniqueSkillName(skill);
                let tips = [];
                let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "various topics";

                tips.push(`Consistently model 'think-alouds' when you demonstrate ${skillName.toLowerCase()}. Example for Planning: 'Okay, for our ${randomInterest} project, my first step is to gather materials. I need to think about what those are... Hmm, paper, crayons, and maybe some glitter!' This makes the internal process visible.`);
                tips.push(`Provide specific, positive reinforcement immediately when students attempt or successfully use ${skillName.toLowerCase()} strategies. Describe the behavior you saw: "I noticed you took three deep breaths when the ${randomInterest} tower fell – that was excellent ${generateUniqueSkillName('Emotional Regulation (EF)')}!" or "You made a clear plan for your ${randomInterest} story, great ${generateUniqueSkillName('Planning and Organization')}!" Focus on effort and strategy use, not just outcome.`);
                tips.push(`Break down multi-step directions, especially for tasks requiring strong ${skill.includes("Working Memory") ? "Working Memory" : skillName.toLowerCase()}. Use visuals (like a mini-schedule for a ${randomInterest} activity sequence) and minimize classroom distractions during focused work times. Check for understanding frequently using varied methods (e.g., "Tell me the first step," "Show me what to do next").`);
                tips.push(`Establish highly predictable classroom routines and clearly post visual schedules. This reduces cognitive load, supports "Foundational Regulators" (K-1) and "Emerging Self-Managers" (2-3), and helps students who find ${skillName.toLowerCase()} or transitions challenging. Provide verbal and visual warnings 5 and 2 minutes before transitions.`);

                if (skill.includes("Inhibition") || skill.includes("Impulse Control")) {
                    tips.push(`For ${skillName.toLowerCase()}: Use explicit visual cues (e.g., stop signs, hand signals like a 'pause' button) and provide pre-corrects before activities requiring waiting, turn-taking (like in a ${randomInterest} game), or quiet focus. Teach specific phrases like "May I have a turn, please?" or "I need a break." as replacement behaviors for impulsivity.`);
                    if (gradeLevel === "K-1") { 
                        tips.push(`Keep wait times very brief initially and gradually increase. Use songs, fingerplays, or movement breaks (like "Wiggle like a ${randomInterest} worm, then freeze!") to help during transitions or waiting periods. This supports "Guided Participants".`);
                    } else { 
                        tips.push(`Teach explicit 'Stop, Think, Choose' or 'See it, Say it (internally), Do it' routines. For older students ("Reflective Adapters"), discuss natural long-term consequences of impulsive actions and practice problem-solving alternative responses in social scenarios related to ${randomInterest || "peer interactions"}.`);
                    }
                }
                if (skill.includes("Emotional Regulation")) {
                    tips.push(`Create a clearly defined 'calm-down space' or 'reflection spot' with optional sensory tools (if appropriate for your students and not overly stimulating). Proactively teach and practice calming techniques (e.g., 'Box Breathing', 'Grounding exercises using senses to describe a ${randomInterest} object') when students *are* calm, not just reactively during an incident. Validate all feelings ("It's okay to feel frustrated...") before guiding to a strategy.`);
                    if (allSelectedSkillsRaw.some(s => s.includes("Communication Skills"))) { 
                        tips.push(`Explicitly teach students to use "I feel..." statements and to appropriately request help or a break (e.g., "I feel frustrated with this ${randomInterest} worksheet, may I have some help?" or "I need a 2-minute break, please.") This serves as a functional replacement for disruptive emotional outbursts.`);
                    }
                }
                if (skill.includes("Planning and Organization") || skill.includes("Initiation")) {
                    tips.push(`For ${skillName.toLowerCase()}: Use visual planners (daily/weekly), graphic organizers (for a ${randomInterest} report), checklists, or 'First-Then' boards (especially for K-1). Break large assignments into smaller, named steps with clear start/end points. For "Initiation," a visual timer for starting work or a 'task initiation routine' (e.g., 3 deep breaths, look at first step) can be helpful.`);
                    if (gradeLevel === "4-6") { 
                        tips.push(`Encourage students to self-monitor their use of planning tools for their ${randomInterest} projects and reflect on which strategies are most effective for them (metacognition), aligning with "Intentional Strategist" development. Provide opportunities for them to adapt plans if initial ideas don't work (Cognitive Flexibility).`);
                    }
                }
                if (skill.includes("Task Refusal") || skill.includes("Noncompliance")) { 
                    tips.push(`If task refusal for a ${randomInterest || "subject"} assignment occurs, try to understand the function (is the task too difficult? unclear? too long? student seeking to avoid it?). Consider task modifications: shorten it, simplify directions, offer choices in how to complete it (e.g., write or draw about ${randomInterest}), or provide a model. Ensure the student knows how to appropriately ask for help or a brief break. Reinforce effort and any step towards compliance, not just perfect completion.`);
                }
                if (skill.includes("Attention and Focus")) {
                    tips.push(`For ${skillName.toLowerCase()}: Minimize auditory and visual distractions during focused work. Provide clear, concise instructions, perhaps written and verbal. Consider preferential seating away from high-traffic areas. Allow for short, structured movement breaks (e.g., 2 minutes of stretching before a ${randomInterest} read-aloud) or sensory tools if these are helpful and not distracting to others. Schedule highly engaging ${randomInterest}-themed activities after more demanding tasks.`);
                }
                if (skill.includes("Cognitive Flexibility")) {
                    tips.push(`When routines change or unexpected problems arise (e.g., a planned ${randomInterest} activity isn't possible), explicitly label it as a chance to practice "flexible thinking." Brainstorm alternative solutions as a class or in small groups. Praise students for adapting without major distress. This supports the "Flexible Adapter" stage.`);
                }
                if (skill.includes("Social Skills") || skill.includes("Communication Skills")) {
                    tips.push(`Use structured social skills instruction: model, role-play, provide feedback, and reinforce positive interactions during natural opportunities (e.g., group work on a ${randomInterest} project, recess games). Use visual supports for social rules or conversation steps, especially for "Emerging Peers" or "Foundational Communicators".`);
                }

                if (preferredModalities.includes('discussionOriented')) {
                    tips.push(`Since discussion is a preferred modality, ensure ample time for 'Think-Pair-Share' or Socratic questioning when exploring ${skillName.toLowerCase()} strategies related to ${randomInterest || "topics"}.`);
                }
                if (preferredModalities.includes('artsCrafts') && !skill.includes("Planning")) { 
                    tips.push(`Integrate arts/crafts: Students can create visual reminders for ${skillName.toLowerCase()} strategies (e.g., a "Stoplight" for impulse control with a ${randomInterest} character).`);
                }

                if (tips.length > 0) {
                    let finalTips = [];
                    finalTips.push(getRandomElement(tips));
                    if (tips.length > 1 && Math.random() > 0.3) { 
                        let secondTip = getRandomElement(tips.filter(t => t !== finalTips[0]));
                        if (secondTip) finalTips.push(secondTip);
                    }
                    return finalTips.join(" ");
                }
                return "Remember to model and reinforce these skills consistently throughout the day in various contexts!";
            }

            function generateIntegrationIdeas(skillsRaw, gradeLevel, studentInterests = []) { 
                let ideas = `<ul class="list-disc list-inside pl-4 text-sm space-y-1">`;
                const uniqueSkillsText = generateSkillList(skillsRaw);
                let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "classroom activities";
                let capRandomInterest = randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1);
                let capAllInterests = studentInterests.length > 0 ? studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(' or ') : capRandomInterest;

                ideas += `<li><strong>Morning Meeting/Circle Time:</strong> Start with a quick game (e.g., a memory game with ${capRandomInterest} pictures for Working Memory), a brief scenario discussion ("What if two friends want the same ${capRandomInterest} toy?" for Conflict Resolution/Social Skills), or a mindful minute to practice ${generateUniqueSkillName('Attention and Focus')}. Reinforce vocabulary related to "${uniqueSkillsText}".</li>`;
                ideas += `<li><strong>Academic Task Framing:</strong> Explicitly state which of the ${uniqueSkillsText.toLowerCase()} will be helpful for specific academic tasks. Example: "For this ${capRandomInterest} science experiment, we'll need strong ${generateUniqueSkillName('Planning and Organization')} to follow the steps and ${generateUniqueSkillName('Self-Monitoring (EF)')} to check our results. How will we use those skills?"</li>`;
                ideas += `<li><strong>Visual Timers & Schedules:</strong> Use visual timers for tasks and display a daily visual schedule. This supports ${generateUniqueSkillName('Time Management')}, ${generateUniqueSkillName('Initiation')}, and predictability for students who need it, especially "Foundational Regulators" and those working on ${generateUniqueSkillName('Adaptive Behavior')}. Tie schedule icons to ${capAllInterests} where possible.</li>`;
                ideas += `<li><strong>Choice Boards & Interest-Based Projects:</strong> Offer choices in how students complete assignments or allow them to select project topics related to ${capAllInterests}. Then, explicitly teach how ${uniqueSkillsText.toLowerCase()} (e.g., ${generateUniqueSkillName('Planning and Organization')} for a ${capRandomInterest} diorama) can help them manage their choices and succeed in these passion projects.</li>`;
                ideas += `<li><strong>Transition Cues & Songs:</strong> Use predictable verbal cues, songs, or visual signals for transitions. Practice using ${generateUniqueSkillName('Inhibition (Impulse Control)')} and ${generateUniqueSkillName('Working Memory')} to follow transition routines smoothly. For K-1, make it a game: "Can we transition like quiet ${capRandomInterest} explorers?"</li>`;
                ideas += `<li><strong>"Oops!" Moments & Flexible Thinking:</strong> When unexpected things happen (e.g., a planned ${capRandomInterest} activity is rained out), label it as an opportunity to practice ${generateUniqueSkillName('Cognitive Flexibility')}. Brainstorm alternative solutions as a class. "Our ${capRandomInterest} outdoor game isn't possible. What are two other fun things we could do?"</li>`;
                ideas += `<li><strong>Literature Connections & Character Study:</strong> During read-alouds (perhaps books about ${capAllInterests}), pause to discuss how characters are using (or not using) skills like ${uniqueSkillsText.toLowerCase()}. "How did the character show ${generateUniqueSkillName('Emotional Regulation (EF)')} when they felt sad about their ${capRandomInterest} drawing?" Use stories to model expectations.</li>`;
                ideas += `<li><strong>"Strategy Share" Board:</strong> Create a space where students can share (drawings for K-1, written notes for older grades) a strategy they used successfully for one of the ${uniqueSkillsText.toLowerCase()}, possibly related to a ${capRandomInterest} task.</li>`;
                ideas += `<li><strong>Home-School Communication Note:</strong> Briefly inform families about the current skill focus (e.g., "This week in our ${capRandomInterest}-themed unit, we are working on ${generateUniqueSkillName(getRandomElement(skillsRaw))}! You can support this at home by..."). Suggest a simple way they can reinforce it.</li>`;
                ideas += `</ul>`;
                return ideas;
            }

            function generateProgressMonitoringTips(skillsRaw, gradeLevel, studentInterests = []) { 
                let tips = `<ul class="list-disc list-inside pl-4 text-sm space-y-1">`;
                const focusSkillsText = generateSkillList(skillsRaw);
                let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "learning activities";
                const dataCollectionSourceNote = " (Consider referring to 'Best Practices for K-6 Behavior Data Collection' for detailed methodologies and ensuring operational definitions are clear)."; 

                tips += `<li><strong>Direct Observation & Anecdotal Records:</strong> During various activities (especially those related to student interests like ${randomInterest}), take brief, objective notes on specific instances where students demonstrate or struggle with ${focusSkillsText.toLowerCase()}. Note the context (A-B-C if relevant). This provides rich qualitative data.</li>`;

                if (skillsRaw.some(skill => skill.includes("Attention and Focus") || skill.toLowerCase().includes("off-task"))) {
                    tips += `<li>For <strong>Attention/Focus skills</strong>: Consider using <strong>Duration Recording</strong> to measure total time on-task during independent work on a ${randomInterest} task. Alternatively, <strong>Partial-Interval Recording</strong> (e.g., note if off-task at any point in 1-minute intervals) can estimate engagement levels without constant timing.${dataCollectionSourceNote}</li>`;
                }
                if (skillsRaw.some(skill => skill.includes("Impulse Control") || skill.includes("Aggression") || skill.includes("Disruptive Behavior"))) {
                    tips += `<li>For <strong>Impulse Control / Disruptive Behaviors</strong>: <strong>Frequency (Event) Recording</strong> is efficient for counting discrete actions (e.g., call-outs during a ${randomInterest} lesson, number of times a student hits). For more significant behaviors, brief <strong>ABC (Antecedent-Behavior-Consequence) Recording</strong> for a few key incidents can help identify patterns and potential functions.${dataCollectionSourceNote}</li>`;
                }
                if (skillsRaw.some(skill => skill.includes("Social Skills") || skill.includes("Communication Skills") || skill.includes("Conflict Resolution"))) {
                    tips += `<li>For <strong>Social/Communication/Conflict Skills</strong>: Use <strong>Frequency Recording</strong> to track positive initiations (e.g., asking a peer to share ${randomInterest} materials) or use of specific taught strategies (e.g., using an "I message"). Simple checklists for social routines (e.g., steps for joining a ${randomInterest} game) can be used during structured practice.${dataCollectionSourceNote}</li>`;
                }
                if (skillsRaw.some(skill => skill.toLowerCase().includes("task refusal") || skill.includes("Initiation") || skill.includes("Noncompliance"))) {
                    tips += `<li>For <strong>Task Initiation/Refusal</strong>: <strong>Latency Recording</strong> is excellent for measuring the time between an instruction (e.g., "Please start your ${randomInterest} worksheet") and when the student begins the task. Also, track the frequency of refusal incidents or compliance within a given timeframe.${dataCollectionSourceNote}</li>`;
                }
                if (skillsRaw.some(skill => skill.includes("Planning and Organization") || skill.includes("Self-Monitoring") || skill.includes("Time Management"))) {
                    tips += `<li>For <strong>Planning/Organization/Self-Monitoring/Time Management</strong>: Use <strong>Permanent Product Recording</strong> by reviewing completed work (e.g., planners, graphic organizers for a ${randomInterest} story, checklists with items marked off, self-correction marks on assignments). This provides tangible evidence of skill application without requiring direct observation of the entire process.${dataCollectionSourceNote}</li>`;
                }
                
                tips += `<li><strong>Student Self-Reflection (Age-Appropriate & Brief):</strong>
                                ${gradeLevel === "K-1" ? `Use simple visual scales (e.g., smiley faces for 'I used my listening ears during our ${randomInterest} story') or "I can..." picture statements. Teacher can scribe or guide selection.` : ""}
                                ${gradeLevel === "2-3" ? `Simple rating scales (e.g., 'Red/Yellow/Green light' on 'I followed the plan for our ${randomInterest} activity') or sentence starters like: 'Today, using [skill] was easy/hard because... Next time I will try...'` : ""}
                                ${gradeLevel === "4-6" ? `Have students briefly rate their use of a specific strategy for ${generateUniqueSkillName(getRandomElement(skillsRaw))} during a ${randomInterest} task on an exit ticket. Or, use a quick journal prompt: 'One way I used [skill] today for ${randomInterest} was... One challenge was...'` : ""}</li>`;
                tips += `<li><strong>Work Samples & Portfolio Snapshots:</strong> Collect specific work samples (e.g., a planning sheet for a ${randomInterest} project, a written reflection after a group task) that directly demonstrate the application (or development) of ${focusSkillsText.toLowerCase()}. Date them to show growth.</li>`;
                tips += `<li><strong>Quick Checks for Understanding (CFUs):</strong> After teaching a strategy for ${generateUniqueSkillName(getRandomElement(skillsRaw))}, use a quick CFU like "Show me with your fingers, how many steps are in our ${randomInterest} planning strategy?" or "Turn and tell your partner one time you could use the 'calm down' technique."</li>`;
                tips += `<li><strong>Ethical Data Use Reminder:</strong> All data collected should be used to better understand student needs, adjust instruction, provide positive and constructive feedback, and celebrate growth. Focus on progress, not just perfection. Ensure confidentiality and use data ethically. ${dataCollectionSourceNote}</li>`;
                tips += `</ul>`;
                return tips;
            }


            // END of previously provided enhanced functions
            console.log("DEBUG: Enhanced Interactive Unit Plan Generator script fully initialized and event listeners attached.");
        }); // End DOMContentLoaded
    } catch (e) {
        console.error("DEBUG: A very early JavaScript error occurred:", e.stack);
        // Attempt to display an error message on the page itself if possible
        const body = document.querySelector('body');
        if (body) {
            const errorDiv = document.createElement('div');
            errorDiv.style.backgroundColor = 'red';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '20px';
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.width = '100%';
            errorDiv.style.zIndex = '9999';
            errorDiv.textContent = 'A critical JavaScript error occurred. Please check the browser console (F12) for details. Error: ' + e.message;
            body.prepend(errorDiv);
        }
    }
</script>

</body>
</html>
