<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-6 Unit Plan Generator (Interactive)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #results::-webkit-scrollbar, .skills-list::-webkit-scrollbar {
            width: 8px;
        }
        #results::-webkit-scrollbar-track, .skills-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #results::-webkit-scrollbar-thumb, .skills-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #results::-webkit-scrollbar-thumb:hover, .skills-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #resultsContainer, #resultsContainer * {
                visibility: visible;
            }
            #results {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                visibility: visible;
            }
            header, form, footer, #printButton, #generateButton, #loadingIndicator, 
            #unitPlanForm div:not(#resultsContainer):not(#results), 
            #unitPlanForm label, #unitPlanForm select, #unitPlanForm h3, .tooltip, .tooltip-trigger {
                display: none !important;
                visibility: hidden !important;
            }
            .page-break { 
                page-break-after: always;
            }
        }
        .prose h4 { margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose h5 { margin-top: 1.25em; margin-bottom: 0.25em; }
        .prose h6 { margin-top: 1em; margin-bottom: 0.25em; font-style: italic; }

        /* Tooltip Styles */
        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 100;
            width: max-content;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
        }
        .tooltip.visible {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-trigger {
            cursor: help;
            margin-left: 4px;
            color: #0ea5e9; /* sky-600 */
            font-weight: bold;
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border: 1px solid #0ea5e9;
            border-radius: 50%;
            font-size: 0.75rem;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800 p-4 md:p-8">
    <div id="skillTooltip" class="tooltip"></div>
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-lg p-6 md:p-10">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-sky-700" style="font-family: 'Pacifico', cursive;">Interactive Unit Plan Generator</h1>
            <p class="text-slate-600 mt-2">Customize your K-6 unit plans for Executive Function and Social-Emotional Learning.</p>
        </header>

        <form id="unitPlanForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="gradeLevel" class="block text-sm font-medium text-slate-700 mb-1">Grade Level:</label>
                    <select id="gradeLevel" name="gradeLevel" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="K-1">K–1</option>
                        <option value="2-3">2–3</option>
                        <option value="4-6">4–6</option>
                    </select>
                </div>
                <div>
                    <label for="numWeeks" class="block text-sm font-medium text-slate-700 mb-1">Unit Length:</label>
                    <select id="numWeeks" name="numWeeks" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="4">4 Weeks</option>
                        <option value="5">5 Weeks</option>
                        <option value="6">6 Weeks</option>
                    </select>
                </div>
                <div>
                    <label for="lessonsPerWeek" class="block text-sm font-medium text-slate-700 mb-1">Sessions/Week:</label>
                    <select id="lessonsPerWeek" name="lessonsPerWeek" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="2">2 Sessions</option>
                        <option value="3">3 Sessions</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-sky-600 mb-2">Executive Functioning Skills:</h3>
                    <div id="efSkillsContainer" class="skills-list space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md border-slate-200">
                        </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-rose-600 mb-2">Behavior Skill Areas:</h3>
                    <div id="behSkillsContainer" class="skills-list space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md border-slate-200">
                        </div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">Primary Focus Skills (Optional):</h3>
                <p class="text-xs text-slate-500 mb-2">Select 1 or 2 skills from your checked lists above to give them more emphasis in the unit plan.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="primarySkill1" class="block text-sm font-medium text-slate-700 mb-1">Primary Skill 1:</label>
                        <select id="primarySkill1" name="primarySkill1" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                    <div>
                        <label for="primarySkill2" class="block text-sm font-medium text-slate-700 mb-1">Primary Skill 2:</label>
                        <select id="primarySkill2" name="primarySkill2" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <label for="studentInterests" class="block text-sm font-medium text-slate-700 mb-1">Student Interests (Optional, comma-separated):</label>
                <input type="text" id="studentInterests" name="studentInterests" placeholder="e.g., dinosaurs, space, drawing" class="mt-1 block w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                <p class="text-xs text-slate-500 mt-1">Helps tailor examples and scenarios.</p>
            </div>

            <div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">Preferred Teaching Modalities (Optional):</h3>
                <p class="text-xs text-slate-500 mb-2">Select up to two preferred styles to influence activity suggestions.</p>
                <div id="teachingModalitiesContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="gameBased" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Game-Based</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="movementKinesthetic" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Movement/Kinesthetic</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="artsCrafts" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Arts & Crafts</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="storytellingDrama" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Storytelling/Drama</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="discussionOriented" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Discussion-Oriented</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="teachingModalities" value="techIntegration" class="form-checkbox h-4 w-4 text-sky-600 border-slate-400 rounded focus:ring-sky-500">
                        <span class="text-sm text-slate-700">Tech Integration</span>
                    </label>
                </div>
            </div>

            <div id="error-message" class="text-red-500 text-sm hidden">Please select at least one skill from the checkboxes above.</div>
            
            <button type="button" id="generateButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 duration-150 ease-in-out">
                Generate Unit Plan
            </button>
        </form>

        <div id="loadingIndicator" class="hidden text-center my-8">
            <div class="inline-flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sky-600 text-lg font-semibold">Generating your interactive unit plan...</span>
            </div>
        </div>

        <div id="resultsContainer" class="mt-10 hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-sky-700">Generated Unit Plan</h2>
                <button type="button" id="printButton" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50 transition-colors duration-150 ease-in-out">
                    Print Unit Plan
                </button>
            </div>
            <div id="results" class="bg-slate-50 p-4 md:p-6 rounded-lg border border-slate-200 prose max-w-none prose-headings:text-sky-700 prose-h3:text-sky-600 prose-strong:text-slate-700">
                </div>
        </div>
    </div>

    <footer class="text-center mt-12 pb-8">
        <p class="text-sm text-slate-500">Content generated is for educational purposes and should be reviewed by a qualified educator before implementation. All generated content is original and copyright-safe, based on general educational principles and inspired by the provided framework. Ensure that any student interest inputs are handled appropriately according to privacy best practices.</p>
        <p class="text-xs text-slate-400 mt-1">Tailwind CSS CDN is for development purposes. For production, follow Tailwind CSS installation guidelines.</p>
    </footer>

<script>
    // --- SKILL DEFINITIONS ---
    // These are general definitions. Ensure they align with your understanding and resources.
    const SKILL_DEFINITIONS = {
        "Working Memory": "The ability to hold and manipulate information in mind for short periods. For example, remembering multi-step instructions or details of a story.",
        "Inhibition (Impulse Control)": "The capacity to pause and think before acting or speaking. Helps resist distractions or urges.",
        "Cognitive Flexibility": "The ability to switch perspectives or adapt to new tasks and rules. Enables handling changes and finding multiple solutions.",
        "Planning and Organization": "The ability to set goals, develop steps to reach them, and organize materials or ideas. Vital for projects and tasks.",
        "Emotional Regulation (EF)": "The ability to understand and manage one's emotions. Helps cope with frustration or excitement.",
        "Initiation": "The ability to begin tasks promptly and independently, without procrastination. (Sometimes referred to as Task Initiation).",
        "Self-Monitoring (EF)": "The ability to monitor and evaluate one's own performance or behavior, including noticing mistakes and checking work. (Sometimes referred to as Metacognition).",
        "Time Management": "The ability to estimate time, prioritize tasks, and use time effectively.",
        "Social Skills": "Skills for interacting positively and effectively with others, including communication and cooperation.",
        "Emotional Regulation (BS)": "Managing emotional reactions and expressions appropriately in social contexts and various situations. (Related to EF Emotional Regulation but with behavioral expression focus).",
        "Self-Monitoring (BS)": "Awareness and adjustment of one's behavior in social and learning environments based on feedback and self-assessment. (Related to EF Self-Monitoring).",
        "Impulse Control (BS)": "Controlling behavioral urges and reactions in various situations by pausing and thinking. (Related to EF Inhibition).",
        "Adaptive Behavior": "Skills needed for daily living, problem-solving in everyday situations, and adjusting to different environments and demands.",
        "Communication Skills": "Effectively conveying and receiving information, ideas, and feelings, both verbally and non-verbally.",
        "Conflict Resolution": "Skills to peacefully and constructively resolve disagreements and problems with others.",
        "Attention and Focus": "The ability to sustain concentration on tasks, filter out distractions, and direct mental effort appropriately. (Related to EF skills like inhibition)."
    };

    const ALL_EF_SKILLS = [
        { value: "Working Memory", display: "Working Memory" },
        { value: "Inhibition (Impulse Control)", display: "Inhibition (Impulse Control)" },
        { value: "Cognitive Flexibility", display: "Cognitive Flexibility" },
        { value: "Planning and Organization", display: "Planning and Organization" },
        { value: "Emotional Regulation (EF)", display: "Emotional Regulation (EF)" },
        { value: "Initiation", display: "Initiation" },
        { value: "Self-Monitoring (EF)", display: "Self-Monitoring (EF)" },
        { value: "Time Management", display: "Time Management" }
    ];

    const ALL_BEH_SKILLS = [
        { value: "Social Skills", display: "Social Skills" },
        { value: "Emotional Regulation (BS)", display: "Emotional Regulation (BS)" },
        { value: "Self-Monitoring (BS)", display: "Self-Monitoring (BS)" },
        { value: "Impulse Control (BS)", display: "Impulse Control (BS)" },
        { value: "Adaptive Behavior", display: "Adaptive Behavior" },
        { value: "Communication Skills", display: "Communication Skills" },
        { value: "Conflict Resolution", display: "Conflict Resolution" },
        { value: "Attention and Focus", display: "Attention and Focus" }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Content Loaded and initial script running."); // For debugging

        const generateButton = document.getElementById('generateButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsDiv = document.getElementById('results');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDiv = document.getElementById('error-message');
        const printButton = document.getElementById('printButton');
        const skillTooltip = document.getElementById('skillTooltip'); // Assuming this is your tooltip element

        const numWeeksSelect = document.getElementById('numWeeks');
        const lessonsPerWeekSelect = document.getElementById('lessonsPerWeek');
        const primarySkill1Select = document.getElementById('primarySkill1');
        const primarySkill2Select = document.getElementById('primarySkill2');
        
        const efSkillsContainer = document.getElementById('efSkillsContainer');
        const behSkillsContainer = document.getElementById('behSkillsContainer');

        console.log("Populating EF/Beh skills checkboxes."); // For debugging
        function populateSkillCheckboxes(container, skills, groupName, colorClass) {
            if (!container) {
                console.error(`Container not found for: ${groupName}. Skill checkboxes will not be populated.`);
                return;
            }
            skills.forEach(skill => {
                const label = document.createElement('label');
                label.className = `flex items-center space-x-3 p-2 rounded-md hover:bg-${colorClass}-50 transition-colors duration-150`;
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = groupName;
                input.value = skill.value;
                input.className = `form-checkbox h-5 w-5 text-${colorClass}-600 border-slate-400 rounded focus:ring-${colorClass}-500`;
                input.addEventListener('change', updatePrimarySkillDropdowns);

                const span = document.createElement('span');
                span.className = 'text-slate-700';
                span.textContent = skill.display;

                const tooltipTrigger = document.createElement('span');
                tooltipTrigger.className = 'tooltip-trigger';
                tooltipTrigger.textContent = '?';
                tooltipTrigger.setAttribute('data-skill', skill.value);
                tooltipTrigger.setAttribute('tabindex', '0'); 

                label.appendChild(input);
                label.appendChild(span);
                label.appendChild(tooltipTrigger);
                container.appendChild(label);
            });
        }

        populateSkillCheckboxes(efSkillsContainer, ALL_EF_SKILLS, 'efSkills', 'sky');
        populateSkillCheckboxes(behSkillsContainer, ALL_BEH_SKILLS, 'behSkills', 'rose');
        
        const efSkillsCheckboxes = Array.from(document.querySelectorAll('input[name="efSkills"]'));
        const behSkillsCheckboxes = Array.from(document.querySelectorAll('input[name="behSkills"]'));

        console.log("Setting up primary skill dropdowns logic."); // For debugging
        function updatePrimarySkillDropdowns() {
            // console.log("Updating primary skill dropdowns..."); // Can be noisy, enable if needed
            const selectedSkills = [...efSkillsCheckboxes, ...behSkillsCheckboxes]
                                     .filter(cb => cb.checked)
                                     .map(cb => ({ value: cb.value, text: generateUniqueSkillName(cb.value) }));

            const currentVal1 = primarySkill1Select ? primarySkill1Select.value : "";
            const currentVal2 = primarySkill2Select ? primarySkill2Select.value : "";

            [primarySkill1Select, primarySkill2Select].forEach(select => {
                if (!select) {
                    console.error("A Primary skill select element was not found during update. Check HTML IDs 'primarySkill1' and 'primarySkill2'.");
                    return;
                }
                select.innerHTML = '<option value="">-- None --</option>'; 
                selectedSkills.forEach(skill => {
                    const option = document.createElement('option');
                    option.value = skill.value; 
                    option.textContent = skill.text; 
                    select.appendChild(option);
                });
            });
            if (primarySkill1Select && selectedSkills.some(s => s.value === currentVal1)) primarySkill1Select.value = currentVal1;
            if (primarySkill2Select && selectedSkills.some(s => s.value === currentVal2)) primarySkill2Select.value = currentVal2;
            // console.log("Primary skill dropdowns updated."); // Can be noisy
        }
        
        console.log("Setting up tooltip listeners."); // For debugging
        document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
            trigger.addEventListener('mouseenter', showTooltip);
            trigger.addEventListener('mouseleave', hideTooltip);
            trigger.addEventListener('focus', showTooltip);
            trigger.addEventListener('blur', hideTooltip);
            trigger.addEventListener('click', (e) => { 
                e.preventDefault(); 
                if (skillTooltip.classList.contains('visible') && skillTooltip.dataset.currentTrigger === trigger.dataset.skill) {
                    hideTooltip();
                } else {
                    showTooltip.call(trigger, e); 
                }
            });
        });

        // CORRECTED/SIMPLIFIED showTooltip function
        function showTooltip(event) {
            const trigger = event.currentTarget; 
            const skillKey = trigger.dataset.skill;
            const definition = SKILL_DEFINITIONS[skillKey] || "No definition available.";
            
            skillTooltip.innerHTML = definition; // Directly set innerHTML
            skillTooltip.dataset.currentTrigger = skillKey; 

            const rect = trigger.getBoundingClientRect();
            // Position tooltip relative to the viewport, then add scroll offsets
            skillTooltip.style.left = `${rect.left + window.scrollX}px`;
            skillTooltip.style.top = `${rect.bottom + window.scrollY + 5}px`; 
            
            skillTooltip.classList.add('visible');
        }

        function hideTooltip() {
            if (skillTooltip) { // Check if skillTooltip exists
               skillTooltip.classList.remove('visible');
               delete skillTooltip.dataset.currentTrigger;
            }
        }

        document.addEventListener('click', (e) => { 
            if (skillTooltip && !skillTooltip.contains(e.target) && e.target && !e.target.classList.contains('tooltip-trigger')) {
                hideTooltip();
            }
        });

        // Null checks for critical elements
        if (!generateButton) { console.error("Critical Error: Generate button (generateButton) not found!"); return; }
        if (!printButton) { console.error("Critical Error: Print button (printButton) not found!"); return; }
        if (!resultsContainer) { console.error("Critical Error: Results container (resultsContainer) not found!"); return; }
        if (!resultsDiv) { console.error("Critical Error: Results div (results) not found!"); return; }
        if (!loadingIndicator) { console.error("Critical Error: Loading indicator (loadingIndicator) not found!"); return; }
        if (!errorMessageDiv) { console.warn("Warning: Error message div (error-message) not found."); } // Less critical
        if (!skillTooltip) { console.error("Critical Error: Skill tooltip div (skillTooltip) not found!"); return; }
        if (!numWeeksSelect || !lessonsPerWeekSelect || !primarySkill1Select || !primarySkill2Select) {
             console.error("Critical Error: One or more form select elements (numWeeks, lessonsPerWeek, primarySkill1/2) not found!"); return;
        }
        if (!efSkillsContainer || !behSkillsContainer) {
             console.error("Critical Error: Skill checkbox containers (efSkillsContainer or behSkillsContainer) not found!"); return;
        }
        
        printButton.addEventListener('click', () => { window.print(); });

        generateButton.addEventListener('click', () => {
            const gradeLevel = document.getElementById('gradeLevel').value;
            const selectedEfSkills = efSkillsCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
            const selectedBehSkills = behSkillsCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
            const allSelectedSkillsRaw = [...selectedEfSkills, ...selectedBehSkills];
            
            const userNumWeeks = parseInt(numWeeksSelect.value);
            const userLessonsPerWeek = parseInt(lessonsPerWeekSelect.value);
            const primarySkill1 = primarySkill1Select.value;
            const primarySkill2 = primarySkill2Select.value;
            const primarySkills = [primarySkill1, primarySkill2].filter(Boolean);

            const studentInterestsInput = document.getElementById('studentInterests').value.trim();
            const studentInterests = studentInterestsInput ? studentInterestsInput.split(',').map(interest => interest.trim().toLowerCase()).filter(interest => interest !== "") : [];


            const preferredModalitiesCheckboxes = document.querySelectorAll('input[name="teachingModalities"]:checked');
            const preferredModalities = Array.from(preferredModalitiesCheckboxes).map(cb => cb.value);

            if (allSelectedSkillsRaw.length === 0) {
                if (errorMessageDiv) { errorMessageDiv.classList.remove('hidden'); } 
                else { alert("Please select at least one skill area."); }
                if (resultsContainer) resultsContainer.classList.add('hidden');
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                return;
            }
            
            if (errorMessageDiv) errorMessageDiv.classList.add('hidden'); // Hide error if shown previously
            if (resultsContainer) resultsContainer.classList.add('hidden');
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (resultsDiv) resultsDiv.innerHTML = ''; 

            setTimeout(() => {
                try {
                    const unitPlan = generateUnitPlanContent(gradeLevel, selectedEfSkills, selectedBehSkills, userNumWeeks, userLessonsPerWeek, primarySkills, studentInterests, preferredModalities);
                    if (resultsDiv) resultsDiv.innerHTML = unitPlan;
                    if (loadingIndicator) loadingIndicator.classList.add('hidden');
                    if (resultsContainer) {
                        resultsContainer.classList.remove('hidden');
                        resultsContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (error) {
                    console.error("Error during unit plan generation:", error);
                    if (resultsDiv) resultsDiv.innerHTML = "<p class='text-red-500'>An error occurred: " + error.message + ". Check console for details.</p>";
                    if (loadingIndicator) loadingIndicator.classList.add('hidden');
                    if (resultsContainer) resultsContainer.classList.remove('hidden'); // Show results container to display error
                }
            }, 500); 
        });

        // --- Helper Functions ---
        function getRandomElement(arr) {
            if (!arr || arr.length === 0) return "";
            return arr[Math.floor(Math.random() * arr.length)];
        }
        
        const CASEL_COMPETENCIES_MAP = { // Keep this map as defined before
            "Working Memory": ["Self-Management", "Responsible Decision-Making"],
            "Inhibition (Impulse Control)": ["Self-Management", "Relationship Skills"],
            "Cognitive Flexibility": ["Social Awareness", "Responsible Decision-Making"],
            "Planning and Organization": ["Self-Management", "Responsible Decision-Making"],
            "Emotional Regulation (EF)": ["Self-Awareness", "Self-Management", "Relationship Skills"],
            "Initiation": ["Self-Management", "Responsible Decision-Making"],
            "Self-Monitoring (EF)": ["Self-Awareness", "Responsible Decision-Making"],
            "Time Management": ["Self-Management", "Responsible Decision-Making"],
            "Social Skills": ["Social Awareness", "Relationship Skills"],
            "Emotional Regulation (BS)": ["Self-Awareness", "Self-Management", "Relationship Skills"],
            "Self-Monitoring (BS)": ["Self-Awareness", "Responsible Decision-Making"],
            "Impulse Control (BS)": ["Self-Management", "Relationship Skills"],
            "Adaptive Behavior": ["Self-Management", "Responsible Decision-Making"],
            "Communication Skills": ["Relationship Skills", "Social Awareness"],
            "Conflict Resolution": ["Relationship Skills", "Responsible Decision-Making"],
            "Attention and Focus": ["Self-Management"]
        };

        function getAssociatedSECompetencies(skill) {
            return CASEL_COMPETENCIES_MAP[skill] || ["Self-Management"]; 
        }

        function generateUniqueSkillName(skill) { 
            if (!skill) return "";
            let displayName = skill;
            if (skill.includes("(EF)")) displayName = skill.replace(" (EF)", " (Executive Functioning)");
            else if (skill.includes("(BS)")) { 
                if (skill === "Emotional Regulation (BS)") displayName = "Behavioral Emotional Regulation";
                else if (skill === "Self-Monitoring (BS)") displayName = "Behavioral Self-Monitoring";
                else if (skill === "Impulse Control (BS)") displayName = "Behavioral Impulse Control";
                else displayName = skill.replace(" (BS)", " (Behavioral)"); 
            }
            else if (skill === "Inhibition (Impulse Control)") displayName = "Inhibition (EF Impulse Control)";
            return displayName;
        }
        
        function generateSkillList(skillsRaw) { 
            const skills = [...new Set(skillsRaw.map(s => generateUniqueSkillName(s)).filter(Boolean))];
            if (skills.length === 0) return "selected focus areas";
            if (skills.length === 1) return skills[0];
            if (skills.length === 2) return skills.join(' and ');
            return skills.slice(0, -1).join(', ') + ', and ' + skills.slice(-1);
        }

        // --- Main Content Generation (Updated Signature) ---
        function generateUnitPlanContent(gradeLevel, efSkills, behSkills, numWeeks, lessonsPerWeekCount, primarySkills, studentInterests, preferredModalities) {
            const allSelectedSkillsRaw = [...efSkills, ...behSkills];
            
            let html = ``;
            const primarySkillForTitle = primarySkills.length > 0 ? generateUniqueSkillName(primarySkills[0]) : (allSelectedSkillsRaw.length > 0 ? generateUniqueSkillName(allSelectedSkillsRaw[0]) : "Key");
            let interestThemeTitleSegment = "";
            if (studentInterests.length > 0) {
                const capitalizedInterests = studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1));
                interestThemeTitleSegment = ` with a Focus on ${capitalizedInterests.join(' & ')} Themes`;
            }
            html += `<h2 class="text-2xl font-bold text-sky-700 mb-3">Unit Title: Strengthening ${primarySkillForTitle} and Related SEL Skills${interestThemeTitleSegment}</h2>`;
            
            html += `<p><strong>Grade Range:</strong> ${gradeLevel}</p>`;
            html += `<p><strong>Focus Executive Functioning Skills:</strong> ${efSkills.length > 0 ? generateSkillList(efSkills) : "None selected"}</p>`;
            html += `<p><strong>Focus Behavioral Skills:</strong> ${behSkills.length > 0 ? generateSkillList(behSkills) : "None selected"}</p>`;
            if (primarySkills.length > 0) {
                 html += `<p><strong>Primary Focus Skill(s):</strong> ${generateSkillList(primarySkills)}</p>`;
            }
            if (studentInterests.length > 0) {
                html += `<p><strong>Student Interests Considered:</strong> ${studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(', ')}</p>`;
            }
            if (preferredModalities.length > 0) {
                html += `<p><strong>Preferred Teaching Modalities Considered:</strong> ${preferredModalities.map(m => m.replace(/([A-Z0-9])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim()).join(', ')}</p>`;
            }

            const allSelCompetenciesForUnit = [...new Set(allSelectedSkillsRaw.flatMap(skill => getAssociatedSECompetencies(skill)))];
            html += `<p><strong>Associated SEL Competencies:</strong> ${allSelCompetenciesForUnit.join(', ')}</p>`;
            html += `<p><strong>Duration:</strong> ${numWeeks} weeks (${lessonsPerWeekCount} sessions per week, approx. 30 min each)</p>`;

            html += `<h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">Unit Overview & Outcomes</h3>`;
            const focusSkillsText = generateSkillList(allSelectedSkillsRaw);
            const overviewInterestsText = studentInterests.length > 0 ? studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(', ') : 'various engaging themes';
            html += `<p>This ${numWeeks}-week unit focuses on developing students' ${focusSkillsText}. Executive functioning and behavioral skills are crucial for academic success, social-emotional well-being, and effective self-regulation. This unit aims to enhance these abilities through targeted activities that are engaging, developmentally appropriate for students in ${gradeLevel}, and incorporates student interests like ${overviewInterestsText}. ${primarySkills.length > 0 ? `Special emphasis will be placed on ${generateSkillList(primarySkills)}.` : ''}</p>`;
            html += `<p><strong>Key Outcomes:</strong> By the end of this unit, students will be better able to:</p>
                       <ul class="list-disc list-inside pl-4 text-sm">
                           <li>Understand the importance of ${focusSkillsText.toLowerCase()} in daily life, including how they relate to their interests.</li>
                           <li>Apply practical strategies related to ${focusSkillsText.toLowerCase()} in classroom and social settings, using preferred learning styles where possible.</li>
                           <li>Demonstrate growth in associated Social-Emotional Learning (SEL) competencies such as ${allSelCompetenciesForUnit.join(', ').toLowerCase()}.</li>
                           <li>Reflect on their own skill development and identify areas for continued practice.</li>
                       </ul>`;

            for (let i = 1; i <= numWeeks; i++) { // i is weekNum
                html += `<div class="mt-6 pt-4 border-t border-slate-300 page-break">`; 
                let weeklyThemeSkillsRaw = [];
                // Prioritize primary skills for weekly themes
                if (primarySkills.length > 0) {
                    weeklyThemeSkillsRaw.push(primarySkills[i % primarySkills.length]); 
                    if (primarySkills.length === 1 && allSelectedSkillsRaw.length > 1) { // If one primary, add another selected skill
                        let otherSkill = getRandomElement(allSelectedSkillsRaw.filter(s => s !== primarySkills[0]));
                        if (otherSkill) weeklyThemeSkillsRaw.push(otherSkill);
                    } else if (primarySkills.length > 1 && (i % primarySkills.length) + 1 < primarySkills.length) {
                         weeklyThemeSkillsRaw.push(primarySkills[(i % primarySkills.length) + 1]); // Add second primary if available
                    }
                }
                // Fill with other selected skills if needed or no primary skills
                while(weeklyThemeSkillsRaw.length < 2 && allSelectedSkillsRaw.length > weeklyThemeSkillsRaw.length) {
                    let nextSkill = getRandomElement(allSelectedSkillsRaw.filter(s => !weeklyThemeSkillsRaw.includes(s)));
                    if (nextSkill) weeklyThemeSkillsRaw.push(nextSkill); else break;
                }
                 if (weeklyThemeSkillsRaw.length === 0 && allSelectedSkillsRaw.length > 0) weeklyThemeSkillsRaw.push(getRandomElement(allSelectedSkillsRaw));
                 if (weeklyThemeSkillsRaw.length === 0) weeklyThemeSkillsRaw.push("Key Foundational Skills");


                const weeklyThemeSkillsText = generateSkillList(weeklyThemeSkillsRaw);
                html += `<h4 class="text-lg font-semibold text-sky-600 mb-1">Week ${i}: Focusing on ${weeklyThemeSkillsText}</h4>`;
                let weeklyInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "engaging topics";
                html += `<p class="italic text-sm text-slate-600 mb-3">This week, activities will center on understanding and practicing ${weeklyThemeSkillsText.toLowerCase()}, linking them to relevant classroom situations, SEL growth, and possibly themes related to ${weeklyInterest}.</p>`;

                for (let j = 1; j <= lessonsPerWeekCount; j++) { // j is lessonNum for the week
                    let lessonFocusSkillRaw = "";
                    // Prioritize primary skills for lessons within the week, then weekly theme skills
                    if (primarySkills.length > 0 && weeklyThemeSkillsRaw.some(s => primarySkills.includes(s))) {
                        lessonFocusSkillRaw = weeklyThemeSkillsRaw.find(s => primarySkills.includes(s)) || getRandomElement(primarySkills);
                    }
                    if (!lessonFocusSkillRaw && weeklyThemeSkillsRaw.length > 0) {
                        lessonFocusSkillRaw = weeklyThemeSkillsRaw[j % weeklyThemeSkillsRaw.length];
                    }
                    if (!lessonFocusSkillRaw && allSelectedSkillsRaw.length > 0) {
                        lessonFocusSkillRaw = getRandomElement(allSelectedSkillsRaw);
                    }
                    if (!lessonFocusSkillRaw) lessonFocusSkillRaw = "a key skill"; // Fallback
                    
                    html += generateSessionContent(lessonFocusSkillRaw, gradeLevel, i, j, allSelectedSkillsRaw, studentInterests, preferredModalities);
                }
                html += `</div>`;
            }

            html += `<div class="mt-8 pt-6 border-t border-slate-300 page-break">`;
            html += `<h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">General Integration Ideas (Throughout the Unit)</h3>`;
            html += generateIntegrationIdeas(allSelectedSkillsRaw, gradeLevel, studentInterests);
            html += `</div>`;

            html += `<div class="mt-8 pt-6 border-t border-slate-300">`;
            html += `<h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">Progress Monitoring & Assessment Ideas</h3>`;
            html += generateProgressMonitoringTips(allSelectedSkillsRaw, gradeLevel);
            html += `</div>`;
            
            return html;
        }

        function generateSessionContent(rawSkill, gradeLevel, weekNum, lessonNum, allSelectedSkillsRaw, studentInterests, preferredModalities) { 
            const skillName = generateUniqueSkillName(rawSkill);
            const selCompetencies = getAssociatedSECompetencies(rawSkill);
            let sessionHtml = `<div class="ml-0 md:ml-4 mt-4 p-4 bg-white rounded shadow-md border border-slate-200">`;
            sessionHtml += `<h5 class="text-md font-semibold text-slate-800 mb-2">Week ${weekNum}, Session ${lessonNum} - Primary Focus: ${skillName}</h5>`;
            
            const interestsForObjective = studentInterests.length > 0 ? studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(' or ') : 'everyday tasks';
            const modalitiesForObjective = preferredModalities.length > 0 ? preferredModalities.map(m => m.replace(/([A-Z0-9])/g, ' $1').toLowerCase().trim()).join(' or ') : 'varied';


            sessionHtml += `<h6>Learning Objectives:</h6><ul class="list-disc list-inside pl-4 text-sm">`;
            sessionHtml += `<li>Students will be able to define ${skillName.toLowerCase()} and identify one way it is used, possibly in relation to their interests like ${interestsForObjective}.</li>`;
            sessionHtml += `<li>Students will practice ${selCompetencies[0].toLowerCase()} by engaging in the session activities, potentially using ${modalitiesForObjective} learning approaches.</li></ul>`;

            const materials = getMaterials(rawSkill, gradeLevel, preferredModalities);
            sessionHtml += `<h6>Materials Needed:</h6><p class="text-sm">${materials.join(', ') || "Basic classroom supplies (whiteboard, markers, paper, pencils)."}</p>`;
            
            sessionHtml += `<h6>Warm-Up (Approx. 5 minutes):</h6><p class="text-sm">${getWarmUp(rawSkill, gradeLevel, weekNum, lessonNum, studentInterests, preferredModalities)}</p>`;

            sessionHtml += `<h6>Mini-Lesson & Discussion (Approx. 5 minutes):</h6><p class="text-sm">${getMiniLesson(rawSkill, gradeLevel, selCompetencies, studentInterests)}</p>`;
            
            const coreActivity = getCoreActivity(rawSkill, gradeLevel, selCompetencies, allSelectedSkillsRaw, studentInterests, preferredModalities);
            sessionHtml += `<h6>Core Activity: ${coreActivity.title} (Approx. 15-20 minutes)</h6>
                            <p class="text-sm">${coreActivity.description}</p>
                            <ol class="list-decimal list-inside pl-4 text-sm space-y-1">`;
            coreActivity.steps.forEach(step => { sessionHtml += `<li>${step}</li>`;});
            sessionHtml += `</ol>`;
            if (coreActivity.differentiation) {
                sessionHtml += `<p class="text-xs italic mt-1">Differentiation Ideas: ${coreActivity.differentiation}</p>`;
            }

            sessionHtml += `<h6>Group Discussion & Reflection (Approx. 5 minutes):</h6><p class="text-sm">${getReflection(rawSkill, gradeLevel, selCompetencies, studentInterests, preferredModalities)}</p>`;

            const closing = getClosing(rawSkill, gradeLevel, studentInterests);
            if (closing) {
                sessionHtml += `<h6>Closing & Preview (Optional, 1-2 minutes):</h6><p class="text-sm">${closing}</p>`;
            }
            
            const teacherTip = getTeacherTip(rawSkill, gradeLevel, preferredModalities);
            if (teacherTip) {
                 sessionHtml += `<p class="text-xs italic mt-2 p-2 bg-sky-50 rounded"><strong>Teacher Tip:</strong> ${teacherTip}</p>`;
            }

            sessionHtml += `</div>`;
            return sessionHtml;
        }

        function getMaterials(skill, gradeLevel, preferredModalities = []) {
            let materials = ["Whiteboard or chart paper", "Markers or pens", "Paper", "Pencils or crayons"];
            if (skill.includes("Time Management") || skill.includes("Planning")) materials.push("Timer (visual for K-2)", "Sample checklists", "Planner templates (optional for 4-6)");
            if (skill.includes("Emotional Regulation")) materials.push("Feeling faces chart/cards (K-2)", "Breathing exercise visual (e.g., 'starfish breathing')", "Role-play scenario cards (2-6)");
            if (skill.includes("Working Memory")) materials.push("Picture cards (K-2)", "Small objects for memory games (K-2)", "List of multi-step directions (2-6)");
            if (gradeLevel === "4-6" && (skill.includes("Organization") || skill.includes("Self-Monitoring"))) materials.push("Student journals/notebooks", "Highlighters/colored pens");
            if (skill.includes("Cognitive Flexibility")) materials.push("Problem-solving scenario cards", "Materials for building/creating (e.g. blocks, craft supplies)");
            
            if (preferredModalities.includes('artsCrafts')) {
                materials.push("Art supplies (colored paper, scissors, glue, play-doh)");
            }
            if (preferredModalities.includes('techIntegration')) {
                materials.push("Access to tablets or computers (if applicable for activity)");
            }
            if (preferredModalities.includes('storytellingDrama')) {
                materials.push("Simple props or costumes (optional)");
            }
            return [...new Set(materials)]; // Remove duplicates
        }

        function getWarmUp(skill, gradeLevel, weekNum, lessonNum, studentInterests = [], preferredModalities = []) {
            const skillName = generateUniqueSkillName(skill);
            let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "a fun topic";
             let capRandomInterest = randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1);

            
            const warmups = [
                `Review: "Last session, we talked about [previous related concept or skill]. Who can share one thing they remember, maybe how it connects to ${capRandomInterest}?"`,
                `Mindful Moment: Lead a 1-minute 'Rainbow Breathing' or 'Listen to the Bell' activity to center students. (SEL: Self-Management/Self-Awareness).`,
                `Quick Brain Teaser: A simple riddle about ${capRandomInterest} or a 'What's different?' picture game. (EF: Attention/Working Memory).`,
                `"Rate Your ${skillName}": Students silently give a thumbs up/middle/down on how they feel their ${skillName.toLowerCase()} skills are today. (SEL: Self-Awareness).`
            ];
             if (gradeLevel === "K-1") {
                warmups.push(`Sing a short, active song related to listening or about ${capRandomInterest} (e.g., "Head, Shoulders, Knees, and Toes" done quickly, then slowly for inhibition).`);
            } else if (gradeLevel === "2-3") {
                 warmups.push(`"Two Truths and a Strategy for ${capRandomInterest}": Teacher shares two true statements about using ${skillName} for ${capRandomInterest} and one 'strategy' that is not helpful. Students identify the non-helpful one.`);
            } else { // 4-6
                warmups.push(`"Quick Write/Draw": Students jot down or sketch one word or image that comes to mind when they hear "${skillName}" in relation to ${capRandomInterest}. Share with a partner.`);
            }

            if (preferredModalities.includes('movementKinesthetic')) { 
                warmups.unshift(`Active Start: Begin with a short, 1-minute movement break (e.g., "Shake Your Sillies Out" or "Follow the Leader" with actions related to ${capRandomInterest}) to get energy flowing before focusing on ${skillName}.`);
            }
            return getRandomElement(warmups);
        }

        function getMiniLesson(skill, gradeLevel, selCompetencies, studentInterests = []) {
            const skillName = generateUniqueSkillName(skill);
            const selText = selCompetencies.join(' and ').toLowerCase();
            let interestExample = "";
            let randomInterest = "";
            if (studentInterests && studentInterests.length > 0) {
                randomInterest = getRandomElement(studentInterests);
                let capRandomInterest = randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1);
                interestExample = ` For example, if you are really interested in ${capRandomInterest}, using good ${skillName.toLowerCase()} can help you learn more about it or build something cool related to ${capRandomInterest}!`;
            }
            const definitionStart = SKILL_DEFINITIONS[skill] ? SKILL_DEFINITIONS[skill].split('.')[0].toLowerCase() : `developing our ability to effectively manage this skill`;

            let intro = `Today our EF skill focus is **${skillName}**. This means ${definitionStart}. This is super important because it helps us [real-life benefit, e.g., 'succeed in our learning,' 'get along better with friends,' 'reach our goals']. When we practice ${skillName.toLowerCase()}, we are also building our SEL skills like ${selText}.${interestExample}`;
            
            let exampleOrStrategy = "";
            let capRandomInterestForExample = randomInterest ? randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1) : "";

            if (gradeLevel === "K-1") {
                 let K1_interest_ex = capRandomInterestForExample ? `Maybe you want to remember how to draw your favorite ${capRandomInterestForExample} - ${skillName.toLowerCase()} helps!` : `when we need to remember two things our teacher said, that's using our ${skillName.toLowerCase()}!`;
                exampleOrStrategy = `For example, ${K1_interest_ex} We can use a special signal like tapping our head to help us remember.`;
            } else if (gradeLevel === "2-3") {
                let G23_interest_ex = capRandomInterestForExample ? `planning a big project about ${capRandomInterestForExample}` : `planning a birthday party`;
                exampleOrStrategy = `Think about ${G23_interest_ex} – you need to decide all the parts. That's ${skillName.toLowerCase()} in action! A strategy we can use is to make a list.`;
            } else { // 4-6
                 let G46_interest_ex = capRandomInterestForExample ? `completing a detailed report on ${capRandomInterestForExample}` : `a long-term project`;
                exampleOrStrategy = `Consider ${G46_interest_ex}. To do well, you need to use ${skillName.toLowerCase()} to break it down, manage your time, and check your progress. We can use tools like a digital calendar or a detailed checklist. How does this connect to being responsible (SEL)?`;
            }
            return intro + ` ${exampleOrStrategy} Let's discuss: Can you think of a time you used ${skillName.toLowerCase()} this week, or when it was tricky?`;
        }
        
        function getCoreActivity(skill, gradeLevel, selCompetencies, allSelectedSkillsRaw, studentInterests = [], preferredModalities = []) {
            const skillName = generateUniqueSkillName(skill);
            const selText = selCompetencies[0].toLowerCase();
            let activity = { title: `Strengthening Our ${skillName}`, description: `Let's dive into an activity to actively build our ${skillName.toLowerCase()} and practice ${selText} (SEL).`, steps: ["Follow teacher's instructions.", "Participate respectfully.", "Reflect on your experience."], differentiation: "Adjust complexity based on student responses." };

            const baseActivityTypes = ["Game", "Role-Play", "Strategy Instruction", "Hands-On Task/Project Intro"];
            if (gradeLevel === "4-6") baseActivityTypes.push("Case Study/Problem-Solving", "Goal Setting & Planning Session");
            
            let chosenActivityType = "";
            let modalityInfluenceApplied = false; 

            if (preferredModalities && preferredModalities.length > 0) {
                const shuffledModalities = [...preferredModalities].sort(() => 0.5 - Math.random());
                for (const modality of shuffledModalities) {
                    if (modality === "gameBased" && baseActivityTypes.includes("Game")) { chosenActivityType = "Game"; modalityInfluenceApplied = true; break; }
                    if (modality === "storytellingDrama" && baseActivityTypes.includes("Role-Play")) { chosenActivityType = "Role-Play"; modalityInfluenceApplied = true; break;}
                    if (modality === "movementKinesthetic" && (skill.includes("Inhibition") || skill.includes("Attention") || skill.includes("Impulse Control")) && baseActivityTypes.includes("Game")) {
                        chosenActivityType = "Game"; modalityInfluenceApplied = true; break;
                    }
                    if (modality === "artsCrafts" && baseActivityTypes.includes("Hands-On Task/Project Intro")) {
                        chosenActivityType = "Hands-On Task/Project Intro"; modalityInfluenceApplied = true; break;
                    }
                     if (modality === "techIntegration" && (skill.includes("Working Memory") || skill.includes("Planning") || skill.includes("Self-Monitoring (EF)")) && baseActivityTypes.includes("Game")) { 
                        chosenActivityType = "Game"; modalityInfluenceApplied = true; break;
                    }
                    if (modality === "discussionOriented" && gradeLevel === "4-6" && baseActivityTypes.includes("Case Study/Problem-Solving")) {
                         chosenActivityType = "Case Study/Problem-Solving"; modalityInfluenceApplied = true; break;
                    }
                }
            }

            if (!chosenActivityType) {
                if (skill.includes("Inhibition") || skill.includes("Impulse Control") || skill.includes("Attention")) chosenActivityType = "Game";
                else if (skill.includes("Social Skill") || skill.includes("Communication") || skill.includes("Conflict Resolution") || skill.includes("Emotional Regulation")) chosenActivityType = "Role-Play";
                else if (skill.includes("Planning") || skill.includes("Organization") || skill.includes("Time Management") || skill.includes("Initiation") || skill.includes("Self-Monitoring")) chosenActivityType = "Strategy Instruction";
                else chosenActivityType = getRandomElement(baseActivityTypes);
            }
            
            let interestFlavor = studentInterests.length > 0 ? getRandomElement(studentInterests) : "";
            let interestPrefix = "";
            if (interestFlavor) {
                interestPrefix = interestFlavor.charAt(0).toUpperCase() + interestFlavor.slice(1) + "-Themed ";
            }

            switch (chosenActivityType) {
                case "Game":
                    activity.title = `${interestPrefix}${skillName} Power Game!`;
                    if (skill.includes("Working Memory")) {
                        activity.description = `This memory game, perhaps about ${interestFlavor || "cool facts"}, will supercharge our ${skillName.toLowerCase()} (SEL: ${selText}).`;
                        activity.steps = gradeLevel === "K-1" ? [`'Magic ${interestFlavor || "Cup"}' game: Hide a small ${interestFlavor || "object"} under one of three cups, shuffle, students guess.`, `Visual sequence recall: Show a sequence of 2-3 picture cards (maybe of ${interestFlavor || "animals"}), remove, students recreate the sequence.`] : 
                                         gradeLevel === "2-3" ? [`'Classroom ${interestFlavor || "Treasure"} Hunt': Give 3-step verbal directions to find a hidden '${interestFlavor || "treasure"}' (e.g., a special eraser).`, `Auditory memory: Read a short list of 5-7 words related to ${interestFlavor || "a story"}, students try to write down as many as they can recall.`] :
                                         [`'Remember the ${interestFlavor || "Details"}': Show a busy picture (perhaps of a ${interestFlavor || "scene"}) for 30 seconds. Remove it. Ask specific detail questions.`, preferredModalities.includes('techIntegration') ? `'Digital Challenge': Play an online EF game (e.g., related to ${interestFlavor || "puzzles"}) that targets working memory.` : `A complex board game (like one about ${interestFlavor || "strategy"}) that requires remembering rules and pieces.`];
                        activity.differentiation = "K-1: Use fewer items/steps. 4-6: Increase items/steps, add distractors.";
                    } else if (skill.includes("Inhibition") || skill.includes("Impulse Control")) {
                        activity.description = `Let's practice our ${skillName.toLowerCase()} with this 'stop and think' game. Imagine you are a ${interestFlavor || "statue"}! (SEL: ${selText}).`;
                        if (preferredModalities.includes('movementKinesthetic') || modalityInfluenceApplied && chosenActivityType === "Game" && (skill.includes("Inhibition") || skill.includes("Impulse Control"))) {
                            activity.steps = gradeLevel === "K-1" ? [`'${interestPrefix || "Animal"} Freeze Dance': Dance like various ${interestFlavor || "animals"} when music plays, freeze when it stops.`, "Discuss how it felt to stop suddenly."] :
                                                           [`'Red Light, ${interestPrefix || "Green Monster"} Light': Adapt red-light green-light with the theme of ${interestFlavor || "monsters"}.`, "Discuss strategies for freezing quickly."];
                        } else { 
                            activity.steps = gradeLevel === "K-1" ? ["'Body Freek': Teacher calls out body parts, students touch them. If teacher says 'Freek!' instead of a body part, students must freeze.", "Discuss how it felt to stop suddenly."] :
                                                           ["'Color/Shape Switch': Students sort items by color. Teacher calls 'Switch!' and they must then sort by shape, inhibiting the previous rule.", "Discuss how they managed to switch rules."];
                        }
                        activity.differentiation = "K-1: Slower pace. 4-6: Faster pace, student leaders.";
                    } else { 
                        activity.description = `A fun game involving ${interestFlavor || "quick thinking"} to activate our ${skillName.toLowerCase()} skills and practice ${selText} (SEL).`;
                        activity.steps = [`Teacher introduces a game tailored to the skill (e.g., a 'Follow the Leader' variation for attention, perhaps pretending to be ${interestFlavor || "explorers"}).`, "Play, emphasizing the target skill.", "Discuss how the skill helped win or play the game effectively."];
                    }
                    break;
                case "Role-Play":
                    activity.title = `Real-Life ${interestPrefix}Scenarios: Using ${skillName}`;
                    activity.description = `Let's act out some everyday situations, maybe involving ${interestFlavor || "friends"}, where we need ${skillName.toLowerCase()}. This helps us practice ${selCompetencies.join(' & ').toLowerCase()} (SEL).`;
                    let scenario = `You're trying to build the tallest ${interestFlavor || "block tower"} and it keeps falling, making you feel frustrated. (Focus: ${skillName})`;
                    if (skill.includes("Social Skills")) scenario = `You want to join a game of '${interestFlavor || "tag"}' at recess but you're not sure how. (Focus: ${skillName})`;
                    if (skill.includes("Cognitive Flexibility")) scenario = `You planned to use the ${interestFlavor || "blue paint"} but someone else is using it. (Focus: ${skillName})`;
                    activity.steps = [
                        `Introduce a relatable scenario: "${scenario}"`,
                        `Brainstorm: What are different ways to react? What would be a helpful way using our ${skillName.toLowerCase()} skill?`,
                        "In pairs or small groups, students act out a positive resolution.",
                        "Class provides feedback: What went well? What SEL skills were shown?"
                    ];
                    activity.differentiation = `K-1: Use puppets (perhaps ${interestFlavor}-themed) or teacher-led role-play. 4-6: Students develop their own ${interestFlavor}-themed scenarios.`;
                    if (preferredModalities.includes('storytellingDrama') && !modalityInfluenceApplied) activity.differentiation += ` Emphasize expressive acting and storytelling.`;
                    break;
                case "Strategy Instruction":
                    activity.title = `Unlocking ${skillName} with a Super ${interestPrefix}Strategy!`;
                    let strategy = `the 'Task Plan Attack' (Break it down, Order steps, Time estimate, Attack the first step, Check progress)`;
                    if (skill.includes("Emotional Regulation")) strategy = `the '${interestPrefix || "Calm Down"} Combo' (Stop, Name feeling, Belly breathe, Choose a calm thought)`;
                    if (skill.includes("Self-Monitoring")) strategy = `the '${interestPrefix || "Self-Check"} Stoplight' (Red: Am I stuck? Yellow: Do I need to re-read? Green: I understand!)`;
                    activity.description = `We're learning a powerful strategy today called '${strategy}' to help us master ${skillName.toLowerCase()} when working on things like ${interestFlavor || "our projects"}, and practice ${selText} (SEL).`;
                    activity.steps = [
                        `Teacher explicitly teaches the steps of the chosen strategy, using visuals and modeling (thinking aloud), perhaps relating it to a ${interestFlavor || "challenge"}.`,
                        `Connect the strategy to a current academic task or a common classroom challenge (e.g., completing a worksheet about ${interestFlavor || "a topic"}).`,
                        "Students practice applying the strategy with guidance.",
                        "Discuss: How did this strategy feel? When else could you use it?"
                    ];
                    activity.differentiation = "K-1: Focus on one simple step, use icons. 4-6: Apply to a multi-step task, students create own mnemonic.";
                    break;
                case "Hands-On Task/Project Intro":
                    activity.title = `Mission: ${skillName} in Action with ${interestPrefix || "a Fun Project"}!`;
                    let task = `design a poster about ${interestFlavor || "classroom safety"} that teaches younger students about one of our classroom rules. This will require good ${skillName.toLowerCase()}.`;
                     if (skill.includes("Organization")) task = `work as a team to sort and label a mixed box of ${interestFlavor || "art"} supplies in 15 minutes.`;
                     if (preferredModalities.includes('artsCrafts') || (modalityInfluenceApplied && chosenActivityType === "Hands-On Task/Project Intro")) {
                        task = `create a collage or diorama about ${interestFlavor || "a favorite book"} using various materials, which will require good ${skillName.toLowerCase()}.`;
                     }
                    activity.description = `Time for a hands-on mission! We'll ${task}. This project will need us to use our ${skillName.toLowerCase()} skills and practice ${selCompetencies.join(' & ').toLowerCase()} (SEL).`;
                    activity.steps = [
                        "Present the mission/task and its goal clearly.",
                        `Brainstorm as a class how ${skillName.toLowerCase()} will be essential for success in our ${interestFlavor || "mission"}.`,
                        "If a group task, help students assign roles or break down the task into manageable parts.",
                        "Students begin the task, with the teacher facilitating and observing."
                    ];
                    activity.differentiation = "K-1: Simple task with a model. 4-6: More open-ended project.";
                    break;
                case "Case Study/Problem-Solving": 
                     activity.title = `Detective Work: Solving ${interestPrefix}Problems with ${skillName}`;
                     let caseStudy = `A student keeps forgetting their homework about ${interestFlavor || "history"}. What EF skills might be challenging, and what 3 strategies could they try?`;
                     if (skill.includes("Cognitive Flexibility")) caseStudy = `A group project about ${interestFlavor || "science"} isn't going well because members disagree on the main idea. How can they use cognitive flexibility?`;
                     activity.description = `Let's put on our detective hats! We'll analyze a situation: "${caseStudy}". We need ${skillName.toLowerCase()} skills and ${selText} (SEL).`;
                     activity.steps = ["Present the case study or problem scenario.", "In small groups, students discuss the problem, identify the EF/SEL skills involved, and brainstorm potential solutions or strategies.", "Each group shares their top 1-2 solutions and explains their reasoning.", "Class discusses the most effective or ethical solutions."];
                     if (preferredModalities.includes('discussionOriented') && !modalityInfluenceApplied) activity.differentiation += ` Facilitate a structured debate or Socratic seminar around the case study.`;
                     break;
                case "Goal Setting & Planning Session": 
                    activity.title = `My ${interestPrefix}${skillName} Goal & Action Plan`;
                    activity.description = `Today, we'll set a personal goal related to ${skillName.toLowerCase()} (maybe for your ${interestFlavor || "hobbies"}?) and make a plan. This is key for ${selText} (SEL).`;
                    activity.steps = ["Discuss the importance of setting SMART goals (Specific, Measurable, Achievable, Relevant, Time-bound) in an age-appropriate way.", `Students choose one aspect of ${skillName.toLowerCase()} they want to improve (e.g., 'I will start my ${interestFlavor || "morning work"} within 2 minutes of the bell').`, "Guide them to write down their goal and 1-2 simple action steps to help them achieve it this week.", "Optional: Share goals with a partner for accountability. Schedule a brief check-in later in the week."];
                    break;
                default: 
                     activity.title = `Exploring ${skillName} with ${interestPrefix || "Activities"}`;
                     activity.description = `Let's explore ${skillName.toLowerCase()} through various ${interestFlavor || "engaging"} activities and discussions, practicing ${selText} (SEL).`;
                     activity.steps = [`Discuss what ${skillName} means, using examples related to ${interestFlavor || 'school'}.`, "Engage in a teacher-led activity focusing on the skill.", "Share experiences."];
            }

            if (!modalityInfluenceApplied && preferredModalities && preferredModalities.length > 0 && activity.differentiation) {
                const currentDiff = activity.differentiation ? activity.differentiation.toLowerCase() : "";
                if (preferredModalities.includes('artsCrafts') && !currentDiff.includes('art') && !currentDiff.includes('craft')) {
                    activity.differentiation += ` For an arts & crafts variation, have students draw or build something related to the ${skillName} strategy or a ${interestFlavor || 'lesson concept'}.`;
                }
                if (preferredModalities.includes('storytellingDrama') && chosenActivityType !== 'Role-Play' && !currentDiff.includes('story') && !currentDiff.includes('drama')) {
                     activity.differentiation += ` To incorporate storytelling, create a short story about a character (perhaps a ${interestFlavor || "student"}) using (or struggling with) ${skillName}.`;
                }
                 if (preferredModalities.includes('techIntegration') && !currentDiff.includes('tech') && !currentDiff.includes('digital') && !currentDiff.includes('online')) {
                     activity.differentiation += ` Explore educational apps or websites that reinforce ${skillName}, possibly with a ${interestFlavor || ''} theme if available.`;
                 }
                 if (preferredModalities.includes('movementKinesthetic') && chosenActivityType !== 'Game' && !currentDiff.includes('movement')) {
                    activity.differentiation += ` Add a movement component: e.g., students physically move to different 'stations' for steps of a plan, or act out emotions.`;
                 }
                 if (preferredModalities.includes('discussionOriented') && chosenActivityType !== 'Case Study/Problem-Solving' && !currentDiff.includes('discuss')) {
                    activity.differentiation += ` Emphasize partner talks or small group discussions about the strategies or scenarios.`;
                 }
            }
            return activity;
        }

        function getReflection(skill, gradeLevel, selCompetencies, studentInterests = [], preferredModalities = []) {
            const skillName = generateUniqueSkillName(skill);
            const selText = selCompetencies[0].toLowerCase(); 
            let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests).charAt(0).toUpperCase() + getRandomElement(studentInterests).slice(1) : "something you enjoy";
            let modalityUsed = preferredModalities.length > 0 ? `learning through ${preferredModalities.map(m=>m.replace(/([A-Z0-9])/g, ' $1').toLowerCase().trim()).join(' and ')}` : "today's activity";

            let questions = [
                `"What was the main skill we focused on today (${skillName.toLowerCase()})? How did you use it during ${modalityUsed}, maybe when thinking about ${randomInterest}?"`,
                `"What was one part of the activity that felt easy for you? What part was a bit challenging?" (SEL: Self-Awareness)`,
                `"How can practicing ${skillName.toLowerCase()} help you with your schoolwork, with your friends, or even with ${randomInterest}?" (SEL: ${selText}, Relationship Skills)`,
                `"Can you think of one specific time this week (outside this lesson) when you can try to use ${skillName.toLowerCase()}?"`
            ];
            if (gradeLevel === "K-1") {
                questions.push(`"Give a 'brain hug' if you tried hard today! How does your brain feel after working on ${skillName.toLowerCase()} and thinking about ${randomInterest}?"`);
            } else if (gradeLevel === "2-3") {
                questions.push(`"What's one 'aha!' moment you had about ${skillName.toLowerCase()} or ${selText} today, especially related to ${modalityUsed}?"`);
            } else { // 4-6
                questions.push(`"On a scale of 1 to 5, how confident do you feel using the main strategy we practiced for ${skillName.toLowerCase()}? What would help you feel more confident? Did ${modalityUsed} help?" (SEL: Self-Awareness)`);
            }
            return `Gather for a debrief. Use prompts like: ${getRandomElement(questions)} ${getRandomElement(questions.slice(1)) || ""}. Encourage sharing and connect back to real-world applications and interests.`;
        }

        function getClosing(skill, gradeLevel, studentInterests = []) {
            const skillName = generateUniqueSkillName(skill);
            let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests).charAt(0).toUpperCase() + getRandomElement(studentInterests).slice(1) : "your favorite things";
            if (Math.random() < 0.75) { 
                let closingPrompt = `Great work today, ${skillName.toLowerCase()} superstars! For your 'mission' this week, try to consciously use one strategy we discussed, maybe even when you're busy with ${randomInterest}.`;
                if (gradeLevel === "K-1") closingPrompt = `Awesome job! Remember to use your ${skillName.toLowerCase()} listening ears and thinking caps, especially when you're playing with ${randomInterest}!`;
                if (gradeLevel === "4-6") closingPrompt = `Excellent focus today. Next time, we'll explore how ${skillName.toLowerCase()} connects to [another related skill or real-world challenge like completing a ${randomInterest} project]. Consider one way this skill impacts your long-term goals.`;
                return closingPrompt;
            }
            return "";
        }
        
        function getTeacherTip(skill, gradeLevel, preferredModalities = []) {
            const skillName = generateUniqueSkillName(skill);
            let tips = [
                `Consistently model 'think-alouds' when you use ${skillName.toLowerCase()} yourself. For example, 'I need to remember three things, so I'm going to say them out loud and make a picture in my mind.'`,
                `Break down instructions into smaller chunks, especially for tasks requiring strong ${skillName.toLowerCase()}. Use visuals whenever possible.`,
                `Acknowledge and praise effort and specific strategies students use related to ${skillName.toLowerCase()}, not just correct answers. E.g., "I saw you take a deep breath before answering, that's great ${generateUniqueSkillName('Emotional Regulation (EF)')}!"`,
                `Create a predictable classroom routine. This reduces cognitive load and supports students who find ${skillName.toLowerCase()} challenging.`,
                `Link ${skillName.toLowerCase()} to CASEL SEL competencies explicitly. E.g., "When you plan your work (Planning & Organization), you're practicing Self-Management."`
            ];
            if (skill.includes("Flexibility")) tips.push("When unexpected changes occur in the classroom, label it as a chance to practice 'flexible thinking'.");
            if (skill.includes("Initiation")) tips.push("For students struggling with task initiation, try using a visual timer for the first 5 minutes of work, or a 'First-Then' board.");
            if (gradeLevel === "K-1") tips.push(`Incorporate movement and song into practicing ${skillName.toLowerCase()}. Keep direct instruction very brief and highly interactive.`);
            if (gradeLevel === "4-6") tips.push(`Encourage students to reflect on *which* strategies for ${skillName.toLowerCase()} work best for *them*. Promote metacognitive conversations.`);
            
            if (preferredModalities.includes('discussionOriented')) {
                tips.push(`Since discussion is a preferred modality, ensure ample time for turn-and-talks or Socratic-style questioning when exploring ${skillName}.`);
            }
            if (preferredModalities.includes('movementKinesthetic')) {
                tips.push(`Look for opportunities to naturally embed movement into lessons on ${skillName}, like acting out steps of a plan or using body signals for self-monitoring.`);
            }
            if (preferredModalities.includes('artsCrafts')) {
                tips.push(`Allow students to represent their understanding of ${skillName} or related strategies through drawing, building, or crafting, which can be a powerful way to solidify concepts.`);
            }

            if (Math.random() < 0.85) return getRandomElement(tips); 
            return "";
        }

        function generateIntegrationIdeas(skillsRaw, gradeLevel, studentInterests = []) { 
            let ideas = `<ul class="list-disc list-inside pl-4 text-sm space-y-1">`;
            const uniqueSkillsText = generateSkillList(skillsRaw);
            let randomInterest = studentInterests.length > 0 ? getRandomElement(studentInterests) : "various topics";
            let capitalizedInterests = studentInterests.map(i => i.charAt(0).toUpperCase() + i.slice(1)).join(' or ');
            if (!capitalizedInterests && randomInterest) capitalizedInterests = randomInterest.charAt(0).toUpperCase() + randomInterest.slice(1);
            else if (!capitalizedInterests) capitalizedInterests = "various topics";


            ideas += `<li><strong>Morning Meeting/Circle Time:</strong> Start the day with a quick game or discussion prompt related to "${uniqueSkillsText}". Reinforce vocabulary, perhaps using examples from ${capitalizedInterests}.</li>`;
            ideas += `<li><strong>Academic Integration:</strong> Explicitly identify when ${uniqueSkillsText.toLowerCase()} are needed for specific subject tasks (e.g., "This science experiment about ${randomInterest} requires careful ${generateUniqueSkillName('Planning and Organization')} and ${generateUniqueSkillName('Self-Monitoring (EF)')}.").</li>`;
            ideas += `<li><strong>Visual Reminders:</strong> Co-create anchor charts with students outlining key strategies for ${uniqueSkillsText.toLowerCase()}, possibly decorated with ${capitalizedInterests} themes.</li>`;
            ideas += `<li><strong>Leverage Student Interests:</strong> When assigning projects or allowing choice, guide students to pick topics like ${capitalizedInterests} that naturally engage them, then explicitly discuss how ${uniqueSkillsText.toLowerCase()} can help them succeed in these passion projects.</li>`;
            ideas += `<li><strong>Transitions & Routines:</strong> Embed practice. E.g., "Let's see how quickly and quietly we can transition, using our ${generateUniqueSkillName('Inhibition (Impulse Control)')}." Award points for smooth transitions.</li>`;
            ideas += `<li><strong>Problem-Solving Wall:</strong> When classroom problems arise, guide students to use taught EF/SEL strategies to solve them, perhaps charting solutions on a "Problem-Solving Wall".</li>`;
            ideas += `<li><strong>Literature Links:</strong> Read stories where characters (perhaps even characters interested in ${randomInterest}) demonstrate (or struggle with) ${uniqueSkillsText.toLowerCase()}. Discuss the character's choices and feelings.</li>`;
            ideas += `<li><strong>"EF Skill of the Week" Focus:</strong> Highlight one specific skill across all classroom activities for a week, with a small class celebration for collective effort.</li>`;
            ideas += `<li><strong>Home-School Communication:</strong> Share simple language or one key strategy with families related to the current ${uniqueSkillsText.toLowerCase()} focus via a newsletter or app, maybe suggesting how they can connect it to the child's interest in ${randomInterest} at home.</li>`;
            ideas += `</ul>`;
            return ideas;
        }

        function generateProgressMonitoringTips(skillsRaw, gradeLevel) { 
            let tips = `<ul class="list-disc list-inside pl-4 text-sm space-y-1">`;
            const focusSkillsText = generateSkillList(skillsRaw);

            tips += `<li><strong>Observational Notes:</strong> During lessons and unstructured times, jot down specific examples of students applying (or needing support with) ${focusSkillsText.toLowerCase()}. Use a simple +/- or a coding system for target behaviors.</li>`;
            tips += `<li><strong>Targeted Checklists:</strong> Develop brief checklists for specific tasks where ${focusSkillsText.toLowerCase()} are key (e.g., for a planning activity: 'Student listed steps? Y/N', 'Student gathered materials? Y/N').</li>`;
            tips += `<li><strong>Student Self-Assessment (Age-Appropriate):</strong>
                            ${gradeLevel === "K-1" ? "Use smiley face scales or 'I can...' statements with pictures (e.g., 'I can wait my turn: [picture of waiting]')." : ""}
                            ${gradeLevel === "2-3" ? "Simple rating scales (1-3) or sentence completion: 'When I need to focus, I can try to...'." : ""}
                            ${gradeLevel === "4-6" ? "Have students set a weekly EF/SEL goal and reflect on their progress using a journal or a structured reflection sheet. Discuss 'What worked? What was tricky? What next?'." : ""}</li>`;
            tips += `<li><strong>Portfolio/Work Samples:</strong> Collect samples that demonstrate application of ${focusSkillsText.toLowerCase()} (e.g., a completed plan, a reflection on a group task, a self-corrected piece of work).</li>`;
            tips += `<li><strong>Exit Tickets:</strong> After a lesson, ask a quick question: "Name one strategy for ${getRandomElement(skillsRaw) || 'staying focused'} we learned today." or "How did you use [SEL competency] in our activity?"</li>`;
            tips += `<li><strong>Peer Feedback (Grades 3-6):</strong> Structure opportunities for students to give kind and specific feedback to peers on collaborative tasks, focusing on skills like communication or teamwork.</li>`;
            tips += `<li><strong>Regular Check-ins:</strong> Briefly conference with individual students or small groups about their progress with ${focusSkillsText.toLowerCase()}, helping them identify strengths and areas for growth.</li>`;
            tips += `<li><strong>Remember to focus on growth over time.</strong> Use this information to adjust instruction, provide targeted support, and celebrate student successes in developing these crucial skills.</li>`;
            tips += `</ul>`;
            return tips;
        }
        console.log("Initial script setup complete. Event listeners are active."); // For debugging
    });
</script>

</body>
</html>
